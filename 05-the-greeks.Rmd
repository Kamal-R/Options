<!-- Each chapter is set to compile separately - include "global" set-up -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Source: https://davidgohel.github.io/officedown/articles/captions.html
knitr::opts_chunk$set(
  fig.cap.style = "Image Caption",
  fig.cap.pre = "", fig.cap.sep = "")

knitr::opts_chunk$set(
  tab.cap.style = "Table Caption",
  tab.cap.pre = "", tab.cap.sep = "")

CRAN_repo = getOption("repos")
CRAN_repo["CRAN"] = "http://cran.us.r-project.org"
options(repos = CRAN_repo)

if ( !require("here") )          { install.packages("here") };            require(here)
if ( !require("tidyverse") )     { install.packages("tidyverse") };       require(tidyverse)
if ( !require("ggtext") )        { install.packages("ggtext") };          require(ggtext)
if ( !require("pBrackets") )     { install.packages("pBrackets") };       require(pBrackets)
if ( !require("htmlwidgets") )   { install.packages("htmlwidgets") };     require(htmlwidgets)
if ( !require("plotly") )        { install.packages("plotly") };          require(plotly)
if ( !require("formattable") )   { install.packages("formattable") };     require(formattable)
if ( !require("kableExtra") )    { install.packages("kableExtra") };      require(kableExtra)
if ( !require("grid") )          { install.packages("grid") };            require(grid)
if ( !require("magick") )        { install.packages("magick") };          require(magick)
if ( !require("gridExtra") )     { install.packages("gridExtra") };       require(gridExtra)
if ( !require("derivmkts") )     { install.packages("derivmkts") };       require(derivmkts)

options(kableExtra.html.bsTable = TRUE)
options(kableExtra.auto_format = FALSE)

out_width_plot <- "97.5%"
out_width_table <- "97.5%"
grid::grid.locator(unit="npc") 

plot_bg <- "#FFFFFF"
plot_fg <- "#000000" 
plot_fg_alt <- "#969696" 

source("Plotting_Functions.R")
```

```{r Table-Helper-Functions}
at_least_number <- function(x,number) {
  ifelse( typeof(x) == "character", 
          return( as.numeric(gsub('\\(','-',gsub('[)$,]', '', x))) >= number ),
          return( x >= number) )
}

remove_negative_zeros <- function(x) { (x[which(-1e-4 < x & x < 1e-4)] = 0); return(x) }
```


# Thinking in Greeks (Part 1) {#First-Greeks}

Payoff diagrams are fantastic visuals, but the ones we have looked at only tell us about the performance of the option on its expiry date. If we're interested in earlier dates, we need to upgrade the payoff diagram. That's our task in this chapter.


## Delta

Here is one of the first payoff diagrams we saw. It shows us when we'll lose money, when we'll make money, and when we'll switch from losing money to making money. But it tells us even more -- it gives us the *delta* of our investment.

```{r Stock-Demo-Revisted, echo=FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE}
Stock_cost <- 200
x_min = 160; x_max = 240

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit","Loss") )

s1 <- bracketsGrob(0.25, 0.25, 0.25, 0.5, lwd=2, col="red")
s2 <- bracketsGrob(0.75, 0.75, 0.75, 0.5, lwd=2, col="green3")

### Source: https://stackoverflow.com/questions/35633239/add-curly-braces-to-ggplot2-and-then-use-ggsave
temp <- stock_payoff(Stock_Payoff_XYZ, main_title = "Buy XYZ's shares at $200.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( y_axis_labels < 0, "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
     annotate( geom = "text", x = 160, y = -12, color = "red", hjust = 0, 
               label = paste0("Losses"), size = 5 ) + 
     annotate( geom = "text", x = 231, y = 12, color = "green3", hjust = 0, 
               label = paste0("Profits"), size = 5 ) + 
     annotate( geom = "text", x = Stock_cost-7.5, y = min(y_axis_labels), color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost)), size = 4 ) + 
     annotate( geom = "text", x = Stock_cost-7.5, y = min(y_axis_labels), color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +
     annotation_custom( s1 ) + annotation_custom( s2 ) 

temp; rm(temp)
```
*Delta* is how much we participate in a stock moving up or down. If we own the stock, we make `r currency(1)` for every `r currency(1)` the stock goes up, and we lose `r currency(1)` for every `r currency(1)` the stock goes down. We call a stock a *delta one* asset as a shorthand way of describing this dollar-for-dollar relationship. 

We've also seen payoff diagrams for options on their expiry dates, and spent lots of time talking about how they participate dollar-for-dollar in the performance of the stock once they're above their strike price. As a quick refresher, we looked at the call option below. Below it's strike price of \$200, the call expires worthless. It doesn't go up or down in price -- it has a delta of zero. Above it's strike price, it participates dollar-for-dollar in the stock's price movements -- it has a delta of one. 

```{r Call-Option-Payoff-Plot, out.width = out_width_plot, fig.align = "center", message = FALSE}
Call_cost <- 15; Call_K <- 200
x_min <- 140; x_max = 280

Call_Payoff_XYZ_200 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit","Loss") )

c1 <- bracketsGrob(0.25, 0.10, 0.25, 0.255, lwd=2, col="red")
c2 <- bracketsGrob(0.80, 0.69, 0.80, 0.255, lwd=2, col="green3")

temp <- call_payoff(data = Call_Payoff_XYZ_200, main_title = "Buy 1 XYZ call at the $200 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
     annotate( geom = "text", x = 145, y = -7, color = "red", hjust = 0, 
               label = paste0("Losses"), size = 5 ) + 
     annotate( geom = "text", x = 270, y = 20.5, color = "green3", hjust = 0, 
               label = paste0("Profits"), size = 5 ) + 
     annotate( geom = "text", x = Call_K+Call_cost-14, y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost)), size = 4 ) + 
     annotate( geom = "text", x = Call_K+Call_cost-14, y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +
     annotation_custom( c1 ) + annotation_custom( c2 ) 

temp; rm(temp)
```

Try not to confuse the strike price of `r currency(200)` with the breakeven of `r currency(215)`. For a call, the strike price is the price you have the option of buying the shares at. These calls cost `r currency(15)`, so we have to make `r currency(15)` back to get to breakeven before the call becomes profitable. But we start going up dollar-for-dollar at `r currency (200)` to make that `r currency (15)` back at `r currency (215)`. 

We've seen stocks, which are delta one. And we've seen calls on their expiry date, which have a delta of zero below their strike price and a delta of one above their strike price. What about the payoffs of calls (and puts) before their expiry date? It depends on how far away from expiry the call is. We'll explore this by looking at the payoff diagram of the `r currency(200)` strike call 3, 6, and 12 months before it's expiry date. 

Before we get into it, a quick note -- the cost of a call varies depending on how far away from expiry it is. The intuition is that the closer the `r currency(200)` strike call gets to expiring, the less time the stock has to go up. So it loses (time) value every day. We'll get into the details of how that works when we talk about two other greeks, *theta* and *vega*. For now, I'll say we bought the call for `r currency(15)` like before, and that we hold it until it is 3, 6, or 12 months from expiry. 

```{r XYZ-Delta-3-Months-Before-Expiry-200, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260

Call_x <- seq(from = x_min, to = x_max, by = 0.1)
Call_price <- sapply(Call_x, function(x) { bscall(s = x, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0) })
Call_cost <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_payoff <- Call_price - Call_cost

Call_delta <- vector(length = length(Call_price)) 
for (ii in 1:length(Call_price)) { 
  Call_delta[ii] <- greeks( bscall(s = x_min-0.1+0.1*ii, k = 200, v = 0.16, 
                                   r = 0.02, tt = 0.25, d = 0) )[2] 
}

idx_1 <- which(Call_x == 160)
tangent_line_1 <- Call_delta[idx_1] * Call_x
tangent_line_1 <- tangent_line_1 - tangent_line_1[idx_1] + Call_payoff[idx_1]

idx_2 <- which(Call_x == Call_K)
tangent_line_2 <- Call_delta[idx_2] * Call_x 
tangent_line_2 <- tangent_line_2 - tangent_line_2[idx_2] + Call_payoff[idx_2]

idx_3 <- which(Call_x == 240)
tangent_line_3 <- Call_delta[idx_3] * Call_x
tangent_line_3 <- tangent_line_3 - tangent_line_3[idx_3] + Call_payoff[idx_3]


Call_Payoff_XYZ_200_3months <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 0.1)),
                       "Call_payoff" = currency(Call_payoff), 
                       "Call_delta_first" = currency(tangent_line_1),
                       "Call_delta_second" = currency(tangent_line_2),
                       "Call_delta_third" = currency(tangent_line_3),
                       "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                             "Profit_call","Loss_call"),
                       "Delta_first" = ifelse( abs(Call_x-160) < 5,"Show_delta_first","Hide_delta_first"), 
                       "Delta_second" = ifelse( abs(Call_x-200) < 5, "Show_delta_second","Hide_delta_second"), 
                       "Delta_third" = ifelse( abs(Call_x-240) < 5, "Show_delta_third","Hide_delta_third") )

Call_Payoff_XYZ_200_expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

annotate_arrow_1 <- data.frame(x1 = 160, x2 = 160, y1 = 0, y2 = -10)
annotate_arrow_2 <- data.frame(x1 = 200-1, x2 = 200-1, y1 = 7.5, y2 = -2.5)
annotate_arrow_3 <- data.frame(x1 = 240-2.5, x2 = 240-2.5, y1 = 42.5, y2 = 32.5)


temp <- call_delta_before_expiry_payoff( data_call_before_expiry = Call_Payoff_XYZ_200_3months, 
                                         data_call_on_expiry = Call_Payoff_XYZ_200_expiry,
                                         main_title = "Buy 1 XYZ call at the $200 strike",
                                         sub_title = "Payoff 3 months before expiry (solid line) vs. \nPayoff at expiry (dotted line).")
temp <- temp + ylim(-20,60)
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- c( ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                         "red", "green3" ) )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
        annotate( geom = "text", x = 150, y = 7.5, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $160\nDelta: 0.009"), size = 4 ) + 
        annotate( geom = "text", x = 190, y = 15, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $200\nDelta: 0.540"), size = 4 ) +
        annotate( geom = "text", x = 227.5, y = 50, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $240\nDelta: 0.984"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
       annotate( geom = "text", x = Call_K+Call_cost-11, y = -20, color = "green3", hjust = 0,
                 label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost)), size = 4 ) + 
       annotate( geom = "text", x = Call_K+Call_cost-11, y = -20, color = "red", hjust = 0,
                 label = "Breakev", size = 4 ) 

temp; rm(temp)
```

For a call, *delta* increases as we move from left to right. It goes from being near 0 at `r currency(160)` to near 1 at `r currency(240)`. *Gamma* is the rate that *delta* (the slope of the payoff) is increasing. The curve is almost a flat line at \$80, which means that *delta* is near 0. It steepens dramatically between \$95 and \$105, which means that *gamma* increases most quickly near \$100. After \$115, the payoff is an almost straight line and cannot steepen much more, which means *delta* is approaching 1 and *gamma* is approaching 0. 

```{r XYZ-Delta-6-Months-Before-Expiry-200, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260

Call_x <- seq(from = x_min, to = x_max, by = 0.1)
Call_price <- sapply(Call_x, function(x) { bscall(s = x, k = 200, v = 0.16, r = 0.02, tt = 0.5, d = 0) })
Call_cost <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.5, d = 0)
Call_payoff <- Call_price - Call_cost

Call_delta <- vector(length = length(Call_price)) 
for (ii in 1:length(Call_price)) { 
  Call_delta[ii] <- greeks( bscall(s = x_min-0.1+0.1*ii, k = 200, v = 0.16, 
                                   r = 0.02, tt = 0.5, d = 0) )[2] 
}

idx_1 <- which(Call_x == 160)
tangent_line_1 <- Call_delta[idx_1] * Call_x
tangent_line_1 <- tangent_line_1 - tangent_line_1[idx_1] + Call_payoff[idx_1]

idx_2 <- which(Call_x == Call_K)
tangent_line_2 <- Call_delta[idx_2] * Call_x 
tangent_line_2 <- tangent_line_2 - tangent_line_2[idx_2] + Call_payoff[idx_2]

idx_3 <- which(Call_x == 240)
tangent_line_3 <- Call_delta[idx_3] * Call_x
tangent_line_3 <- tangent_line_3 - tangent_line_3[idx_3] + Call_payoff[idx_3]


Call_Payoff_XYZ_200_6months <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 0.1)),
                       "Call_payoff" = currency(Call_payoff), 
                       "Call_delta_first" = currency(tangent_line_1),
                       "Call_delta_second" = currency(tangent_line_2),
                       "Call_delta_third" = currency(tangent_line_3),
                       "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                             "Profit_call","Loss_call"),
                       "Delta_first" = ifelse( abs(Call_x-160) < 5,"Show_delta_first","Hide_delta_first"), 
                       "Delta_second" = ifelse( abs(Call_x-200) < 5, "Show_delta_second","Hide_delta_second"), 
                       "Delta_third" = ifelse( abs(Call_x-240) < 5, "Show_delta_third","Hide_delta_third") )

Call_Payoff_XYZ_200_expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

annotate_arrow_1 <- data.frame(x1 = 160, x2 = 160, y1 = 0, y2 = -10)
annotate_arrow_2 <- data.frame(x1 = 200-1, x2 = 200-1, y1 = 7.5, y2 = -2.5)
annotate_arrow_3 <- data.frame(x1 = 240-2.5, x2 = 240-2.5, y1 = 42.5, y2 = 32.5)


temp <- call_delta_before_expiry_payoff( data_call_before_expiry = Call_Payoff_XYZ_200_6months, 
                                         data_call_on_expiry = Call_Payoff_XYZ_200_expiry,
                                         main_title = "Buy 1 XYZ call at the $200 strike",
                                         sub_title = "Payoff 6 months before expiry (solid line) vs. \nPayoff at expiry (dotted line).")
temp <- temp + ylim(-20,60)
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- c( ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                         "red", "green3" ) )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
        annotate( geom = "text", x = 150, y = 7.5, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $160\nDelta: 0.054"), size = 4 ) + 
        annotate( geom = "text", x = 190, y = 15, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $200\nDelta: 0.557"), size = 4 ) +
        annotate( geom = "text", x = 227.5, y = 50, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $240\nDelta: 0.942"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) 

temp; rm(temp)
```


Although I haven't gone through examples yet, you can build good understanding of how *delta* and *gamma* behave just by looking at payoff diagrams. This is an important skill that we'll build up when we look at more options strategies. 

```{r XYZ-Delta-12-Months-Before-Expiry-200, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260

Call_x <- seq(from = x_min, to = x_max, by = 0.1)
Call_price <- sapply(Call_x, function(x) { bscall(s = x, k = 200, v = 0.16, r = 0.02, tt = 1, d = 0) })
Call_cost <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 1, d = 0)

Call_payoff <- Call_price - Call_cost

Call_delta <- vector(length = length(Call_price)) 
for (ii in 1:length(Call_price)) { 
  Call_delta[ii] <- greeks( bscall(s = x_min-0.1+0.1*ii, k = 200, v = 0.16, 
                                   r = 0.02, tt = 1, d = 0) )[2] 
}

idx_1 <- which(Call_x == 160)
tangent_line_1 <- Call_delta[idx_1] * Call_x
tangent_line_1 <- tangent_line_1 - tangent_line_1[idx_1] + Call_payoff[idx_1]

idx_2 <- which(Call_x == Call_K)
tangent_line_2 <- Call_delta[idx_2] * Call_x 
tangent_line_2 <- tangent_line_2 - tangent_line_2[idx_2] + Call_payoff[idx_2]

idx_3 <- which(Call_x == 240)
tangent_line_3 <- Call_delta[idx_3] * Call_x
tangent_line_3 <- tangent_line_3 - tangent_line_3[idx_3] + Call_payoff[idx_3]


Call_Payoff_XYZ_200_12months <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 0.1)),
                       "Call_payoff" = currency(Call_payoff), 
                       "Call_delta_first" = currency(tangent_line_1),
                       "Call_delta_second" = currency(tangent_line_2),
                       "Call_delta_third" = currency(tangent_line_3),
                       "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                             "Profit_call","Loss_call"),
                       "Delta_first" = ifelse( abs(Call_x-160) < 5,"Show_delta_first","Hide_delta_first"), 
                       "Delta_second" = ifelse( abs(Call_x-200) < 5, "Show_delta_second","Hide_delta_second"), 
                       "Delta_third" = ifelse( abs(Call_x-240) < 5, "Show_delta_third","Hide_delta_third") )

Call_Payoff_XYZ_200_expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

annotate_arrow_1 <- data.frame(x1 = 159.5, x2 = 159.5, y1 = 5, y2 = -10)
annotate_arrow_2 <- data.frame(x1 = 199.5, x2 = 199.5, y1 = 15, y2 = 2.5)
annotate_arrow_3 <- data.frame(x1 = 237.5, x2 = 237.5, y1 = 47.5, y2 = 35)


temp <- call_delta_before_expiry_payoff( data_call_before_expiry = Call_Payoff_XYZ_200_12months, 
                                         data_call_on_expiry = Call_Payoff_XYZ_200_expiry,
                                         main_title = "Buy 1 XYZ call at the $200 strike",
                                         sub_title = "Payoff 12 months before expiry (solid line) vs. \nPayoff at expiry (dotted line).")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- c( ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                         "red", "green3" ), "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
        annotate( geom = "text", x = 150, y = 12.5, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $160\nDelta: 0.150"), size = 4 ) + 
        annotate( geom = "text", x = 192.5, y = 20, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $200\nDelta: 0.580"), size = 4 ) +
        annotate( geom = "text", x = 230, y = 55, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $240\nDelta: 0.888"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        ylim(-20,60)

temp; rm(temp)
```

There's also a broader risk-reward story here. The payoff of XYZ's call goes up faster and faster as the stock goes up, so we make money faster and faster. The flip side of that is that the payoff goes down slower and slower as the stock falls, so we lose money slower and slower. *Delta* and *gamma* try to describe this effect with numbers, but most of us won't be using *delta* or *gamma* to aggressively risk-manage positions the way a hedge fund or an algorithm would. That's too complicated and time-consuming for most of us. 

```{r XYZ-Delta-Over-Time-200, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260
Call_x <- seq(from = x_min, to = x_max, by = 0.1)

Call_price_on_expiry <- sapply(Call_x, function(x) { bscall(s = x, k = 200, v = 0.18, r = 0.02, tt = 0, d = 0) })
Call_cost_on_expiry <- 15 # bscall(s = 200, k = 200, v = 0.18, r = 0.02, tt = 0, d = 0)
Call_payoff_on_expiry <- Call_price_on_expiry - Call_cost_on_expiry
Call_delta_on_expiry <- vector(length = length(Call_price_on_expiry)) 
for (ii in 1:length(Call_price_on_expiry)) { 
  Call_delta_on_expiry[ii] <- greeks( bscall(s = x_min-0.1+0.1*ii, k = 200, v = 0.18, 
                                   r = 0.02, tt = 0, d = 0) )[2] 
}

Call_price_3months_expiry <- sapply(Call_x, function(x) { bscall(s = x, k = 200, v = 0.18, r = 0.02, tt = 0.25, d = 0) })
Call_cost_3months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.18, r = 0.02, tt = 0.25, d = 0)
Call_payoff_3months_expiry <- Call_price_3months_expiry - Call_cost_3months_expiry
Call_delta_3months_expiry <- vector(length = length(Call_price_3months_expiry)) 
for (ii in 1:length(Call_price_3months_expiry)) { 
  Call_delta_3months_expiry[ii] <- greeks( bscall(s = x_min-0.1+0.1*ii, k = 200, v = 0.18, 
                                   r = 0.02, tt = 0.25, d = 0) )[2] 
}

Call_price_6months_expiry <- sapply(Call_x, function(x) { bscall(s = x, k = 200, v = 0.18, r = 0.02, tt = 0.5, d = 0) })
Call_cost_6months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.18, r = 0.02, tt = 0.5, d = 0)
Call_payoff_6months_expiry <- Call_price_6months_expiry - Call_cost_6months_expiry
Call_delta_6months_expiry <- vector(length = length(Call_price_6months_expiry)) 
for (ii in 1:length(Call_price_6months_expiry)) { 
  Call_delta_6months_expiry[ii] <- greeks( bscall(s = x_min-0.1+0.1*ii, k = 200, v = 0.18, 
                                   r = 0.02, tt = 0.5, d = 0) )[2] 
}

Call_price_12months_expiry <- sapply(Call_x, function(x) { bscall(s = x, k = 200, v = 0.18, r = 0.02, tt = 1, d = 0) })
Call_cost_12months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.18, r = 0.02, tt = 1, d = 0)
Call_payoff_12months_expiry <- Call_price_12months_expiry - Call_cost_12months_expiry
Call_delta_12months_expiry <- vector(length = length(Call_price_12months_expiry)) 
for (ii in 1:length(Call_price_12months_expiry)) { 
  Call_delta_12months_expiry[ii] <- greeks( bscall(s = x_min-0.1+0.1*ii, k = 200, v = 0.18, 
                                   r = 0.02, tt = 1, d = 0) )[2] 
}

Call_Delta_XYZ_200_On_Expiry <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 0.1)),
                       "Delta_y" = Call_delta_on_expiry, 
                       "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                             "Profit_call","Loss_call") )

Call_Delta_XYZ_200_3months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Delta_y" = Call_delta_3months_expiry,
                               "Profitable" = ifelse(-Call_cost_3months_expiry + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Call_Delta_XYZ_200_6months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Delta_y" = Call_delta_6months_expiry,
                               "Profitable" = ifelse(-Call_cost_6months_expiry + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Call_Delta_XYZ_200_12months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Delta_y" = Call_delta_12months_expiry,
                               "Profitable" = ifelse(-Call_cost_12months_expiry + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

annotate_arrow_1 <- data.frame(x1 = 187.5, x2 = 197.5, y1 = 0.80, y2 = 0.80)
annotate_arrow_2 <- data.frame(x1 = 190, x2 = 190, y1 = 0.175, y2 = 0.275)
annotate_arrow_3 <- data.frame(x1 = 240, x2 = 240, y1 = 0.75, y2 = 0.85)

temp <- call_delta_over_time( call_delta_on_expiry = Call_Delta_XYZ_200_On_Expiry, 
                              call_delta_3months_expiry = Call_Delta_XYZ_200_3months_Expiry,
                              # call_delta_6months_expiry = Call_Delta_XYZ_200_6months_Expiry,
                              call_delta_12months_expiry = Call_Delta_XYZ_200_12months_Expiry,
                              main_title = "Buy 1 XYZ call at the $200 strike",
                              sub_title = "Compare Call Delta Across Time.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))

temp <- temp + 
        annotate( geom = "text", x = 172.5, y = 0.80, color = "gray50", hjust = 0, 
                  label = paste0("On expiry"), size = 4 ) + 
        annotate( geom = "text", x = 182.5, y = 0.10, color = "gray50", hjust = 0, 
                  label = paste0("3 months\nfrom expiry"), size = 4 ) +
        annotate( geom = "text", x = 232.5, y = 0.675, color = "gray50", hjust = 0, 
                  label = paste0("12 months\nfrom expiry"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) 

temp; rm(temp)
```

But we might use our knowledge of *delta* and *gamma* to construct favorable trades, and to effectively risk-manage them. We're going to do just that after we go through the three remaining greeks. Once we've finished explaining the greeks, we'll exploit our new knowledge to understand the construction and risk management of two more complicated option strategies - the straddle and the put spread. 

Before we move on to *vega*, I want to emphasis that this call's payoff diagram (before expiry) is still *asymmetric*. It's not the all-or-nothing setup we saw in the first two chapters, and we don't quite get dollar-for-dollar participation to the upside. It took an almost \$15 move to the upside in XYZ's stock to get close to that. But there's still asymmetry: we make more and more money as the stock goes up, and lose less and less money as the stock goes down. In one way or another, all options strategies boil down to trying to exploit that asymmetry. 

<!-- 
## Delta 

Let's re

```{r Apple-Call-Option-Payoff, echo=FALSE, out.width = "80%", fig.align = "center", message = FALSE}
Call_cost <- 6.84
Call_K <- 205
Current_price <- 205.44
x_min = 180; x_max = 225
Call_x <- seq(from = x_min, to = x_max, by = 1)

Call_Payoff_Plot <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 1)),
                            "Call_y" = currency(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K)) )

ggplot() + 
  geom_line(data = Call_Payoff_Plot, aes(Call_x, Call_y, color = "Shares"), linetype = "solid") +
  geom_line(data = Call_Payoff_Plot, aes(Call_x, rep(0,length(Call_x)), color = "Breakeven"), linetype = "dashed") +
  geom_line(data = Call_Payoff_Plot, aes(x = Call_K + Call_cost, 
                                         y = seq(from = -Call_cost, to = x_max-Call_K, length=length(Call_x)), 
                                         color = "Breakeven"),
                                         linetype = "dashed") +
  scale_y_continuous(label = scales::dollar) +
  scale_x_continuous(label = scales::dollar) + 
  labs(title = "Buying Apple's $205 Call",
       x = "Stock Price",
       y = "Profit Per Share") +
  scale_color_manual(values = c('Shares'=plot_fg,'Breakeven'=plot_fg,'Breakeven'=plot_fg),
                     labels = c("Profit Per Share",
                                paste0("Breakeven Price = ", currency(Call_K + Call_cost)),
                                paste0("Breakeven Price = ", currency(Call_K + Call_cost)) ),
                     guide = "legend") + 
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed")))) + 
  theme_classic() + 
  theme(plot.title = element_text(hjust = 0.5, face="bold", 
                                  margin = margin(10, 0, 10, 0),
                                  colour = plot_fg),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.title = element_blank(),
        legend.key = element_rect(fill = plot_bg, color = plot_bg),
        legend.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.box.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.text = element_text(colour = plot_fg),
        text = element_text(size=16), 
        panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = plot_bg, color = plot_bg),
        plot.background = element_rect(fill = plot_bg, color = plot_bg),
        axis.line = element_line(colour = plot_bg),
        axis.title.x = element_text(margin = unit(c(4, 0, 0, 0), "mm"), 
                                    colour = plot_fg),
        axis.title.y = element_text(margin = unit(c(0, 4, 0, 0), "mm"), 
                                    angle = 90, colour = plot_fg) )
```

This call's payoff is a flat line below \$205, and goes up dollar-for-dollar above \$205. The two parts of the payoff diagram are all the information that's on this diagram. There is a flat region with a slope of 0, and a straight line with a slope of 1. Those slopes are the *delta* of the call option. 

*Delta* tells us how much an option participates in the price movement of the stock. If Apple is worth more than \$205 when this call expires, we can exercise the call, buy Apple for \$205, and sell it for more than \$205. We make the difference Apple's current price and \$205, which gives us dollar-for-dollar participation to the upside. Another way of saying that is that this call has a *delta* of 1 - it goes up by 1 dollar for every dollar Apple's stock goes up - when Apple's shares are above \$205.

If the call is below \$205, it expires worthless. As long as Apple's stock stays under \$205, Apple's stock can go up as much as it likes and the call will still expires worthless. If Apple is at \$180 and goes up by \$20 to \$200, the call still expires worthless. Another way of saying that is that the call has a *delta* of 0 - it does not go up in price at all - when Apple's stock is below \$205. 

Calls (and puts) always have *delta*, and online brokers tell us what the *delta* of an option is so we don't even have to calculate it. That includes options far away from their expiry dates, which we'll finally look at in this chapter. It's for a ficticious company, Company XYZ, that is trading at \$100. I think XYZ's shares are going higher, so I buy a \$100 strike call for \$3.89. The call is 6 months away from expiring. 

This payoff diagram looks at how much profit we would make if we sell the call later that same day. I've kept the implied volatility of the option the same for all these different prices, which is completely unrealistic. I'll revisit this example when we talk about implied volatility, but I want to focus on *delta* for now. 

Before we get going with *delta*, let's pause and think about breakeven. The best way to think about breakeven is that I pay for a call, and have to recover the cost of buying it before I can make money. In the examples from earlier, we looked at calls that were a couple months from expiring. I bought them in September or October, and they expired in November or December. But, I only looked at their payoffs on their expiry dates. For example, the \$205 strike Apple call cost \$6.84, and I've drawn its payoff on its expiry date. Since I spent \$6.84 on the call, I need Apple's shares to reach \$211.84 *on the expiry date* so that I can exercise the call and make that \$6.84 back. If I drew the payoff diagram the instant after I bought it, the call would still be worth \$6.84. I would be able to sell it and make back that \$6.84, so my breakeven would be \$205.

The same logic holds for XYZ. This \$100 strike call costs \$3.89 and it expires in 6 months. If I was to hold the call until it's expiry date, I would need the stock to go up to \$103.89 so that I could make my money back. So if I drew the payoff diagram for this call on its expiry date, the breakeven would be \$103.89. But I've drawn the payoff diagram the instant after I bought it, which is 6 months from its expiry date. The XYZ call is still worth \$3.89, so I can sell it and get my \$3.89 back. So my breakeven is \$100, which is what it says on the payoff diagram. 

With that out of the way, let's take our first look at *delta*, the slope of the call's payoff. The payoff is in black, and it's delta at \$100 is in grey. The payoff diagram shows that the grey line touches the black line at \$100, is fairly close within a few dollars of \$100, and gets further and further away as the stock moves away from \$100. If I was to re-phrase that in terms of *delta*, I would say that the *delta* at \$100 is a good approximation of the payoff near \$100, but it gets progressively worse as the stock moves away from \$100. 

Within \$1 of \$100, I can't see a difference between the two lines. So, I can use the grey line to approximate how much I'll make when the stock goes up by \$1, and how much I'll lose when the stock goes down by \$1. You could eyeball the slope of the grey line off the graph, which I'll do in another example. But since we're given *delta* by our online brokers, I'm just going to give it to you - it's 0.5637. That means that if Company XYZ's stock goes up by \$1, we'll make \$0.56. If it goes down by \$1, we'll lose \$0.56. That's how I like to think about *delta* - its tells me (approximately) how much the call *participates* in the next \$1 move of the stock.

It's super important to notice that calls (and puts) have a different delta for *every* price the stock can take. We can see this in the payoff diagram. The delta I drew only is *only* an exact match for the curve at \$100. As the stock moves away from \$100, it doesn't match the payoff at all. To drive this point home, I'm going to draw in the delta of this call when it's \$90 and \$110. 

```{r XYZ-Before-Expiry-90, echo=FALSE, out.width = "80%", fig.align = "center", message = FALSE}
Call_cost <- bscall(s = 100, k = 100, v = 0.12, r=0.02, tt=0.5, d=0)
Call_K <- 100
Current_price <- 100
x_min = 80; x_max = 120
Call_x <- seq(from = x_min, to = x_max, by = 1)
call_price <- sapply(Call_x, function(x) { bscall(s = x, k = 100, v = 0.12, 
                                                  r=0.02, tt=0.5, d=0) })
call_payoff <- call_price - Call_cost

call_delta <- vector(length = length(call_price)) 
for (ii in 1:length(call_price)) { 
  call_delta[ii] <- greeks( bscall(s = x_min-1+ii, k = 100, v = 0.12, 
                                   r=0.02, tt=0.5, d=0) )[2] 
}

idx <- which(Call_x == 90)
tangent_line <- call_delta[idx]*Call_x
tangent_line <- tangent_line - tangent_line[idx] + call_payoff[idx]

Call_Payoff_Plot <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 1)),
                            "Call_delta" = currency(tangent_line),
                            "Call_payoff" = currency(call_payoff) )

ggplot() + 
  geom_line(data = Call_Payoff_Plot, 
            aes(Call_x, Call_delta, color = "Delta"), 
            linetype = "solid") +
  geom_line(data = Call_Payoff_Plot, 
            aes(Call_x, Call_payoff, color = "Shares"), 
            linetype = "solid") +
  geom_line(data = Call_Payoff_Plot, 
            aes(Call_x, rep(0,length(Call_x)), color = "Breakeven"), 
            linetype = "dashed") +
  geom_line(data = Call_Payoff_Plot, aes(x = Call_K, 
                                         y = seq(from = -3*Call_cost, 
                                                 to = x_max-Call_K, 
                                                 length=length(Call_x)), 
                                         color = "Breakeven"),
                                         linetype = "dashed") +
  scale_y_continuous(label = scales::dollar) +
  scale_x_continuous(label = scales::dollar) + 
  labs(title = "$100 Strike Call - 6 Months from Expiry",
       x = "Stock Price",
       y = "Profit Per Share") +
  scale_color_manual(values = c('Shares'=plot_fg, 'Delta'=plot_fg_alt, 'Breakeven'=plot_fg),
                     labels = c("Profit Per Share",
                                "Delta (at $90)", 
                                paste0("Breakeven Price = ", currency(Call_K))),
                     guide = "legend") + 
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "solid", "dashed")))) + 
  theme_classic() + 
  theme(plot.title = element_text(hjust = 0.5, face="bold", 
                                  margin = margin(10, 0, 10, 0),
                                  colour = plot_fg),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.title = element_blank(),
        legend.key = element_rect(fill = plot_bg, color = plot_bg),
        legend.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.box.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.text = element_text(colour = plot_fg),
        text = element_text(size=16), 
        panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = plot_bg, color = plot_bg),
        plot.background = element_rect(fill = plot_bg, color = plot_bg),
        axis.line = element_line(colour = plot_bg),
        axis.title.x = element_text(margin = unit(c(4, 0, 0, 0), "mm"), 
                                    colour = plot_fg),
        axis.title.y = element_text(margin = unit(c(0, 4, 0, 0), "mm"), 
                                    angle = 90, colour = plot_fg) )
```

This payoff diagram shows the delta of the call at \$90. It is 0.1398, or 13.98% - that tells us that when the stock is at \$90, the call will go up by (approximately) \$0.14 when Company XYZ's stock goes up by \$1.00 or down by (approximately) \$0.14 when it goes down by \$1.00. This is way less than the \$0.56 we saw when the stock was at \$100. In fact, the lower this stock goes, the closer the delta gets to 0. 

This makes sense, because we know the delta *is* 0 if XYZ's shares are below \$100 when the call expires. There's still time for XYZ's shares to get back above \$100, because the call is 6 months from expiring. But the more the shares fall, the less likely that is. So the delta *should* get lower and lower as the shares fall. That's exactly what we see here, with the delta falling from 0.56 to 0.14 as the shares fall from \$100 to \$90. 

```{r XYZ-Before-Expiry-110, echo=FALSE, out.width = "80%", fig.align = "center", message = FALSE}
Call_cost <- bscall(s = 100, k = 100, v = 0.12, r=0.02, tt=0.5, d=0)
Call_K <- 100
Current_price <- 100
x_min = 80; x_max = 120
Call_x <- seq(from = x_min, to = x_max, by = 1)
call_price <- sapply(Call_x, function(x) { bscall(s = x, k = 100, v = 0.12, 
                                                  r=0.02, tt=0.5, d=0) })
call_payoff <- call_price - Call_cost

call_delta <- vector(length = length(call_price)) 
for (ii in 1:length(call_price)) { 
  call_delta[ii] <- greeks( bscall(s = x_min-1+ii, k = 100, v = 0.12, 
                                   r=0.02, tt=0.5, d=0) )[2] 
}

idx <- which(Call_x == 110)
tangent_line <- call_delta[idx]*Call_x
tangent_line <- tangent_line - tangent_line[idx] + call_payoff[idx]


Call_Payoff_Plot <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 1)),
                            "Call_delta" = currency(tangent_line),
                            "Call_payoff" = currency(call_payoff) )

ggplot() + 
  geom_line(data = Call_Payoff_Plot, 
            aes(Call_x, Call_delta, color = "Delta"), 
            linetype = "solid") +
  geom_line(data = Call_Payoff_Plot, 
            aes(Call_x, Call_payoff, color = "Shares"), 
            linetype = "solid") +
  geom_line(data = Call_Payoff_Plot, 
            aes(Call_x, rep(0,length(Call_x)), color = "Breakeven"), 
            linetype = "dashed") +
  geom_line(data = Call_Payoff_Plot, aes(x = Call_K, 
                                         y = seq(from = -3*Call_cost, 
                                                 to = x_max-Call_K, 
                                                 length=length(Call_x)), 
                                         color = "Breakeven"),
                                         linetype = "dashed") +
  scale_y_continuous(label = scales::dollar) +
  scale_x_continuous(label = scales::dollar) + 
  labs(title = "$100 Strike Call - 6 Months from Expiry",
       x = "Stock Price",
       y = "Profit Per Share") +
  scale_color_manual(values = c('Shares'=plot_fg, 'Delta'=plot_fg_alt, 'Breakeven'=plot_fg),
                     labels = c("Profit Per Share",
                                "Delta (at $110)", 
                                paste0("Breakeven Price = ", currency(Call_K))),
                     guide = "legend") + 
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "solid", "dashed")))) + 
  theme_classic() + 
  theme(plot.title = element_text(hjust = 0.5, face="bold", 
                                  margin = margin(10, 0, 10, 0),
                                  colour = plot_fg),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.title = element_blank(),
        legend.key = element_rect(fill = plot_bg, color = plot_bg),
        legend.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.box.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.text = element_text(colour = plot_fg),
        text = element_text(size=16), 
        panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = plot_bg, color = plot_bg),
        plot.background = element_rect(fill = plot_bg, color = plot_bg),
        axis.line = element_line(colour = plot_bg),
        axis.title.x = element_text(margin = unit(c(4, 0, 0, 0), "mm"), 
                                    colour = plot_fg),
        axis.title.y = element_text(margin = unit(c(0, 4, 0, 0), "mm"), 
                                    angle = 90, colour = plot_fg) )
```
The delta of this call at \$110 is 0.9000 - that tells us that when the stock is at \$110, the call will go up by (approximately) \$0.90 when Company XYZ's stock goes up by \$1.00 or down by *approximately* \$0.90 when it goes down by \$1.00. This is way more than the \$0.56 we saw when the stock was at \$100, and the reason why should sound familiar. 

The higher this stock goes, the closer the delta gets to 1. We know the delta *is* 1 if XYZ's shares are above \$100 when the call expires. There's still time for the shares to fall below \$100, but the higher the shares go the more likely they are to be above \$100 in 6 months' time. So delta *should* go up as the shares go up. And that's exactly what happens, with delta increasing from 0.56 to 0.90 as the shares jump from \$100 to \$110. 


## Gamma

Ok, so we know that *delta* changes as the price of XYZ's shares change. Instead of figuring out *delta* by drawing one straight line at a time, we can draw a diagram that shows how delta changes. It's not a payoff diagram, but it is simpler and faster way to visualize delta. 

```{r XYZ-Delta, echo=FALSE, out.width = "80%", fig.align = "center", message = FALSE}
Call_cost <- bscall(s = 100, k = 100, v = 0.12, r=0.02, tt=0.5, d=0)
Call_K <- 100
Current_price <- 100
x_min = 75; x_max = 125
Call_x <- seq(from = x_min, to = x_max, by = 1)

call_delta <- vector(length = length(Call_x)) 
for (ii in 1:length(Call_x)) { 
  call_delta[ii] <- greeks( bscall(s = x_min-1+ii, k = 100, v = 0.12, 
                                   r=0.02, tt=0.5, d=0) )[2] 
}

Call_Delta <- tibble( "Call_x" = currency(seq(from = x_min, 
                                              to = x_max, by = 1)),
                      "Call_delta" = call_delta )

Call_Delta_points <- tibble( "Call_x_points" = currency( c(90, 100, 110) ), 
                             "Call_delta_points" = currency( c( call_delta[which(Call_x == 90)],
                                                                call_delta[which(Call_x == 100)], 
                                                                call_delta[which(Call_x == 110)] ) ),
                             coords = c( paste("(",currency(90), ", ",
                                               round(call_delta[which(Call_x == 90)],2), 
                                               ")", sep=""),
                                         paste("(",currency(100), ", ",
                                               round(call_delta[which(Call_x == 100)],2), 
                                               ")", sep=""),
                                         paste("(",currency(110), ", ",
                                               round(call_delta[which(Call_x == 110)],2), 
                                               ")", sep="") ) )

ggplot() + 
  geom_line(data = Call_Delta, 
            aes(Call_x, Call_delta), linetype = "solid") +
  geom_point(data = Call_Delta_points, 
             aes(Call_x_points, Call_delta_points)) +
  geom_text(data = Call_Delta_points, size = 4,
            aes( x = Call_x_points, y = Call_delta_points, label = coords ),
            hjust=c(0,0,0), vjust=c(1.5,1.5,1.5)) + 
  labs(title = "$100 Strike Call - 6 Months from Expiry",
       x = "Stock Price",
       y = "Delta") +
  theme_classic() + 
  theme(plot.title = element_text(hjust = 0.5, face="bold", 
                                  margin = margin(10, 0, 10, 0),
                                  colour = plot_fg),
        text = element_text(size=16), 
        panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = plot_bg, color = plot_bg),
        plot.background = element_rect(fill = plot_bg, color = plot_bg),
        axis.line = element_line(colour = plot_bg),
        axis.title.x = element_text(margin = unit(c(4, 0, 0, 0), "mm"), 
                                    colour = plot_fg),
        axis.title.y = element_text(margin = unit(c(0, 4, 0, 0), "mm"), 
                                    angle = 90, colour = plot_fg) )
```
This diagram shows how the call's *delta* changes with the stock price. The three values for *delta* that we found earlier - 0.14 at \$90, 0.56 at \$100, and 0.90 at \$110 - are there, but so are a bunch more. Remember, *delta* tells us approximately how much we can expect the price of the call (or put) to move if the stock moves by \$1.00. But there's slightly more to the story - *delta* increases as the stock price goes up, and decreases as the stock goes down. When the stock is going up, we can expect to make slightly more than the *delta* says we should, and when the stock goes down we can expect to lose slightly less.

If we want to have some idea of how much more or how much less, we need to know how fast delta is changing. Thankfully, one of the greeks tells us that. It's called *gamma*. Just like the slope of the payoff tells us how quickly the price of the call changes, the slope of this *delta* curve tells us how fast delta is changing. I'm going to use the same playbook to understand *gamma* that we did to understand *delta* - I'll draw some slopes at different points on the *delta* curve, and then I'll draw a diagram of *gamma* against the stock price. I'll even use the same points - \$90, \$100, and \$100 - that I did with *delta*.

```{r XYZ-Gamma-Before-Expiry-100, echo=FALSE, out.width = "80%", fig.align = "center", message = FALSE}
Call_cost <- bscall(s = 100, k = 100, v = 0.12, r=0.02, tt=0.5, d=0)
Call_K <- 100
Current_price <- 100
x_min = 80; x_max = 120
Call_x <- seq(from = x_min, to = x_max, by = 1)

call_delta <- vector(length = length(call_price)) 
for (ii in 1:length(call_price)) { 
  call_delta[ii] <- greeks( bscall(s = x_min-1+ii, k = 100, v = 0.12, 
                                   r=0.02, tt=0.5, d=0) )[2] 
}

call_gamma <- vector(length = length(call_price)) 
for (ii in 1:length(call_price)) { 
  call_gamma[ii] <- greeks( bscall(s = x_min-1+ii, k = 100, v = 0.12, 
                                   r=0.02, tt=0.5, d=0) )[3] 
}

idx <- which(Call_x == 100)
tangent_line <- call_gamma[idx]*Call_x
tangent_line <- tangent_line - tangent_line[idx] + call_delta[idx]


Call_Delta_Plot <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 1)),
                           "Call_gamma" = currency(tangent_line),
                           "Call_delta" = currency(call_delta) )

ggplot() + 
  geom_line(data = Call_Delta_Plot, 
            aes(Call_x, Call_gamma, color = "Shares"), 
            linetype = "solid") +
  geom_line(data = Call_Delta_Plot, 
          aes(Call_x, Call_delta, color = "Gamma"), 
          linetype = "solid") +
  labs(title = "$100 Strike Call - 6 Months from Expiry",
       x = "Stock Price",
       y = "Delta") +
  scale_color_manual(values = c('Shares'=plot_fg_alt, 'Gamma'=plot_fg),
                     labels = c("Delta",
                                "Gamma (at $100)"),
                     guide = "legend") + 
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "solid")))) + 
  theme_classic() + 
  theme(plot.title = element_text(hjust = 0.5, face="bold", 
                                  margin = margin(10, 0, 10, 0),
                                  colour = plot_fg),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.title = element_blank(),
        legend.key = element_rect(fill = plot_bg, color = plot_bg),
        legend.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.box.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.text = element_text(colour = plot_fg),
        text = element_text(size=16), 
        panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = plot_bg, color = plot_bg),
        plot.background = element_rect(fill = plot_bg, color = plot_bg),
        axis.line = element_line(colour = plot_bg),
        axis.title.x = element_text(margin = unit(c(4, 0, 0, 0), "mm"), 
                                    colour = plot_fg),
        axis.title.y = element_text(margin = unit(c(0, 4, 0, 0), "mm"), 
                                    angle = 90, colour = plot_fg) )
```
We've got *delta* ranging from 0 to 1 in black, and the call's *gamma* at \$100 in grey. Just like before, the grey line is a fantastic approximation of the black line near \$100, and gets worse the further away from \$100 the stock gets. Within \$1 of \$100, it's almost perfect. At \$100, the grey line is slightly higher than 0.5, and at \$110 it is near \$1. That's a rise of slightly less than 0.5 over \$10. The slope is just the rise (0.5) over the run (\$10), so this call's gamma at \$100 is a little smaller than 0.5/\$10 = 0.05 per dollar. 

It actually equals 0.04642, so we got pretty close by eyeballing it. Once we know *gamma* or a good approximation of it, we have a better idea about how much money the call (or put) will make for a \$1 move in XYZ's stock. The *delta* of this call at \$100 is 0.56, which tells us that we'll make \$0.56 the first \$1 that XYZ's shares go up, and lose \$0.56 the first \$1 they go down. 

But the *gamma* at \$100 is 0.04642. That tells us that *delta* increases by about 0.04 to 0.60 when the stock reaches \$101, and falls by about 0.04 to 0.52 when the stock reaches \$99. I'm rounding *gamma* to 0.04, because I want to get a quick and dirty idea of how the call will behave. That's because when I go to buy it, my online broker will tell me that this \$100 strike call has a *delta* of 0.5637 and a *gamma* of 0.04642. 

If I wanted to know how much money I would make or lose for the next \$1 move in the stock, I have to do one more quick approximation. The *delta* increases from 0.56 to 0.60 when the stock increases from \$100 to \$101. I want to know how much of this \$1 move my call captures. It's not \$0.56 because the call's *delta* was going up from 0.56 as the shares went up to \$101 (because of *gamma*), and it's not \$0.60 because the call's *delta* just got to 0.60 when the shares got to \$101. I'm going to approximate it by splitting the difference between \$0.56 and \$0.60, and say that the call captures \$0.58 of the \$1 move higher. 

I'll do the same thing for when the stock goes down by by \$1. The call's *delta* is 0.56 when the shares are at \$100, and it decreases to 0.52 when the shares fall to \$99. To approximate how much of the \$1 loss the call participates in, I'll split the difference between 0.56 and 0.52, and say that the call captures \$0.54 of the \$1 move lower. And even better than being able to do this once is being able to do it all the time. Our online broker will keep giving us new values for *delta* and *gamma* as the shares move around. We can just look them up, and do this quick and dirty calculation. That will give us a good idea of how our call (or put) will behave for the next \$1 move (up or down) in the stock.  

We can eyeball gamma by making diagrams like this one. I'll make the same diagrams for when XYZ's shares are \$90 and \$110, because they'll help build your intuition about how *gamma* behaves. 

```{r XYZ-Gamma-Before-Expiry-90, echo=FALSE, out.width = "80%", fig.align = "center", message = FALSE}
Call_cost <- bscall(s = 100, k = 100, v = 0.12, r=0.02, tt=0.5, d=0)
Call_K <- 100
Current_price <- 100
x_min = 80; x_max = 120
Call_x <- seq(from = x_min, to = x_max, by = 1)

call_delta <- vector(length = length(call_price)) 
for (ii in 1:length(call_price)) { 
  call_delta[ii] <- greeks( bscall(s = x_min-1+ii, k = 100, v = 0.12, 
                                   r=0.02, tt=0.5, d=0) )[2] 
}

call_gamma <- vector(length = length(call_price)) 
for (ii in 1:length(call_price)) { 
  call_gamma[ii] <- greeks( bscall(s = x_min-1+ii, k = 100, v = 0.12, 
                                   r=0.02, tt=0.5, d=0) )[3] 
}

idx <- which(Call_x == 90)
tangent_line <- call_gamma[idx]*Call_x
tangent_line <- tangent_line - tangent_line[idx] + call_delta[idx]


Call_Delta_Plot <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 1)),
                           "Call_gamma" = currency(tangent_line),
                           "Call_delta" = currency(call_delta) )

ggplot() + 
  geom_line(data = Call_Delta_Plot, 
            aes(Call_x, Call_gamma, color = "Shares"), 
            linetype = "solid") +
  geom_line(data = Call_Delta_Plot, 
          aes(Call_x, Call_delta, color = "Gamma"), 
          linetype = "solid") +
  labs(title = "$100 Strike Call - 6 Months from Expiry",
       x = "Stock Price",
       y = "Delta") +
  scale_color_manual(values = c('Shares'=plot_fg_alt, 'Gamma'=plot_fg),
                     labels = c("Delta",
                                "Gamma (at $90)"),
                     guide = "legend") + 
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "solid")))) + 
  theme_classic() + 
  theme(plot.title = element_text(hjust = 0.5, face="bold", 
                                  margin = margin(10, 0, 10, 0),
                                  colour = plot_fg),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.title = element_blank(),
        legend.key = element_rect(fill = plot_bg, color = plot_bg),
        legend.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.box.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.text = element_text(colour = plot_fg),
        text = element_text(size=16), 
        panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = plot_bg, color = plot_bg),
        plot.background = element_rect(fill = plot_bg, color = plot_bg),
        axis.line = element_line(colour = plot_bg),
        axis.title.x = element_text(margin = unit(c(4, 0, 0, 0), "mm"), 
                                    colour = plot_fg),
        axis.title.y = element_text(margin = unit(c(0, 4, 0, 0), "mm"), 
                                    angle = 90, colour = plot_fg) )
```

The *delta*-curve flattens out as the shares fall under \$100, becoming almost completely flat by the time they reach \$80. Another way of saying that is that the *gamma* of the call decreases as the shares fall from \$100, and the *delta* of the call is close to 0 at \$80. And the numbers match the picture. At \$100, the call has 0.04642 of *gamma*. At \$90, the call has 0.0291 of *gamma*, which is less than 0.04642. 

```{r XYZ-Gamma-Before-Expiry-110, echo=FALSE, out.width = "80%", fig.align = "center", message = FALSE}
Call_cost <- bscall(s = 100, k = 100, v = 0.12, r=0.02, tt=0.5, d=0)
Call_K <- 100
Current_price <- 100
x_min = 80; x_max = 120
Call_x <- seq(from = x_min, to = x_max, by = 1)

call_delta <- vector(length = length(call_price)) 
for (ii in 1:length(call_price)) { 
  call_delta[ii] <- greeks( bscall(s = x_min-1+ii, k = 100, v = 0.12, 
                                   r=0.02, tt=0.5, d=0) )[2] 
}

call_gamma <- vector(length = length(call_price)) 
for (ii in 1:length(call_price)) { 
  call_gamma[ii] <- greeks( bscall(s = x_min-1+ii, k = 100, v = 0.12, 
                                   r=0.02, tt=0.5, d=0) )[3] 
}

idx <- which(Call_x == 110)
tangent_line <- call_gamma[idx]*Call_x
tangent_line <- tangent_line - tangent_line[idx] + call_delta[idx]


Call_Delta_Plot <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 1)),
                           "Call_gamma" = currency(tangent_line),
                           "Call_delta" = currency(call_delta) )

ggplot() + 
  geom_line(data = Call_Delta_Plot, 
            aes(Call_x, Call_gamma, color = "Shares"), 
            linetype = "solid") +
  geom_line(data = Call_Delta_Plot, 
          aes(Call_x, Call_delta, color = "Gamma"), 
          linetype = "solid") +
  labs(title = "$100 Strike Call - 6 Months from Expiry",
       x = "Stock Price",
       y = "Delta") +
  scale_color_manual(values = c('Shares'=plot_fg_alt, 'Gamma'=plot_fg),
                     labels = c("Delta",
                                "Gamma (at $110)"),
                     guide = "legend") + 
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "solid")))) + 
  theme_classic() + 
  theme(plot.title = element_text(hjust = 0.5, face="bold", 
                                  margin = margin(10, 0, 10, 0),
                                  colour = plot_fg),
        legend.justification=c(0,1), 
        legend.position=c(0,1), 
        legend.title = element_blank(),
        legend.key = element_rect(fill = plot_bg, color = plot_bg),
        legend.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.box.background = element_rect(fill = plot_bg, color = plot_bg),
        legend.text = element_text(colour = plot_fg),
        text = element_text(size=16), 
        panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = plot_bg, color = plot_bg),
        plot.background = element_rect(fill = plot_bg, color = plot_bg),
        axis.line = element_line(colour = plot_bg),
        axis.title.x = element_text(margin = unit(c(4, 0, 0, 0), "mm"), 
                                    colour = plot_fg),
        axis.title.y = element_text(margin = unit(c(0, 4, 0, 0), "mm"), 
                                    angle = 90, colour = plot_fg) )
```

This *delta*-curve also flattens out as the shares get over \$100, becoming almost flat by the time they reach \$120. Another way of saying that is that the *gamma* of the call is decreasing as the shares go above \$100, and the *delta* of the call is close to 0 at \$120. Once again, the numbers match the picture. At \$100, the call has 0.04642 of *gamma*. At \$110, the call has 0.0187 of *gamma*, which is much less than 0.04642. 

These two diagrams should make it clear - the gamma of an option peaks at (or very near) its strike price, and declines as the stock shares rise or fall away from it. If we think about it long enough, this should match our intuition. *Delta* measures how much this call *participates* in the price movements of a stock, and *gamma* measures how fast the participation is changing. The call expires worthless below its strike of \$100 but makes money over \$100, so the fastest changes in how much the call participates should happen near \$100. 

-->