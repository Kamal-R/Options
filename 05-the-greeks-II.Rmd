<!-- Each chapter is set to compile separately - include "global" set-up -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Source: https://davidgohel.github.io/officedown/articles/captions.html
knitr::opts_chunk$set(
  fig.cap.style = "Image Caption",
  fig.cap.pre = "", fig.cap.sep = "")

knitr::opts_chunk$set(
  tab.cap.style = "Table Caption",
  tab.cap.pre = "", tab.cap.sep = "")

CRAN_repo = getOption("repos")
CRAN_repo["CRAN"] = "http://cran.us.r-project.org"
options(repos = CRAN_repo)

if ( !require("here") )          { install.packages("here") };            require(here)
if ( !require("tidyverse") )     { install.packages("tidyverse") };       require(tidyverse)
if ( !require("ggtext") )        { install.packages("ggtext") };          require(ggtext)
if ( !require("pBrackets") )     { install.packages("pBrackets") };       require(pBrackets)
if ( !require("htmlwidgets") )   { install.packages("htmlwidgets") };     require(htmlwidgets)
if ( !require("plotly") )        { install.packages("plotly") };          require(plotly)
if ( !require("formattable") )   { install.packages("formattable") };     require(formattable)
if ( !require("kableExtra") )    { install.packages("kableExtra") };      require(kableExtra)
if ( !require("grid") )          { install.packages("grid") };            require(grid)
if ( !require("magick") )        { install.packages("magick") };          require(magick)
if ( !require("gridExtra") )     { install.packages("gridExtra") };       require(gridExtra)
if ( !require("derivmkts") )     { install.packages("derivmkts") };       require(derivmkts)

options(kableExtra.html.bsTable = TRUE)
options(kableExtra.auto_format = FALSE)

out_width_plot <- "97.5%"
out_width_table <- "97.5%"
grid::grid.locator(unit="npc") 

plot_bg <- "#FFFFFF"
plot_fg <- "#000000" 
plot_fg_alt <- "#969696" 

source("Plotting_Functions.R")
```

```{r Table-Helper-Functions}
at_least_number <- function(x,number) {
  ifelse( typeof(x) == "character", 
          return( as.numeric(gsub('\\(','-',gsub('[)$,]', '', x))) >= number ),
          return( x >= number) )
}

remove_negative_zeros <- function(x) { (x[which(-1e-4 < x & x < 1e-4)] = 0); return(x) }
```


# Thinking in Greeks (Part II) {#Second-Greeks}

So far, we've covered *delta*, *gamma*, and *rho*. There are two major greeks left -- *vega* and *theta*. They're both related to volatility, so we're taking them on together in this chapter. 


## Vega

```{r XYZ-Straddle-Lognormal-Over-K-Small-SD, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                    "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                    - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                    "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                           - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                           "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_Lognormal <- tibble( "Dist_x" = seq(from = x_min, to = x_max, by = 0.01), 
                                     "Dist_y" = 10 * 1000 * (45/200) * dlnorm(Dist_x, meanlog = log(200), sdlog = log(1.11)) )

# qlnorm( 0.10, meanlog = log(200), sdlog = log(1.11) )
# qlnorm( 0.87, meanlog = log(200), sdlog = log(1.11) )

temp <- straddle_payoff_dist_overlay_volatility( data_straddle_left = Straddle_Payoff_XYZ_left,
                                      data_straddle_center = Straddle_Payoff_XYZ_center,
                                      data_straddle_right = Straddle_Payoff_XYZ_right,
                                      data_distribution_overlay = Straddle_Payoff_Lognormal, 
                                      fill_rgb = col2rgb("cornflowerblue"),
                                      main_title = "A Straddle: Scenario 1",
                                      sub_title = "The market's view of the price of\nXYZ's shares on the expiry date.",
                                      curve_text_1 = "10%",
                                      curve_text_x_1 = 165, 
                                      curve_text_y_1 = 4,
                                      curve_text_2 = "13%",
                                      curve_text_x_2 = 237.5, 
                                      curve_text_y_2 = 4)
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp; rm(temp)
```

```{r XYZ-Straddle-Lognormal-Over-K-Medium-SD, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                    "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                    - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                    "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                           - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                           "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_Lognormal <- tibble( "Dist_x" = seq(from = x_min, to = x_max, by = 0.01), 
                                     "Dist_y" = 10 * 1000 * (45/200) * dlnorm(Dist_x, meanlog = log(200), sdlog = log(1.13)) )

# qlnorm( 0.1375, meanlog = log(200), sdlog = log(1.13) )
# qlnorm( 0.8325, meanlog = log(200), sdlog = log(1.13) )

temp <- straddle_payoff_dist_overlay_volatility( data_straddle_left = Straddle_Payoff_XYZ_left,
                                      data_straddle_center = Straddle_Payoff_XYZ_center,
                                      data_straddle_right = Straddle_Payoff_XYZ_right,
                                      data_distribution_overlay = Straddle_Payoff_Lognormal, 
                                      fill_rgb = col2rgb("cornflowerblue"),
                                      main_title = "A Straddle: Scenario 2",
                                      sub_title = "The market's view of the price of\nXYZ's shares on the expiry date.",
                                      curve_text_1 = "13.75%",
                                      curve_text_x_1 = 162.5, 
                                      curve_text_y_1 = 4,
                                      curve_text_2 = "16.75%",
                                      curve_text_x_2 = 240, 
                                      curve_text_y_2 = 4)
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp; rm(temp)
```

```{r XYZ-Straddle-Lognormal-Over-K-Large-SD, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                    "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                    - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                    "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                           - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                           "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_Lognormal <- tibble( "Dist_x" = seq(from = x_min, to = x_max, by = 0.01), 
                                     "Dist_y" = 10 * 1000 * (45/200) * dlnorm(Dist_x, meanlog = log(200), sdlog = log(1.16)) )

# qlnorm( 0.184, meanlog = log(200), sdlog = log(1.16) )
# qlnorm( 0.786, meanlog = log(200), sdlog = log(1.16) )

temp <- straddle_payoff_dist_overlay_volatility( data_straddle_left = Straddle_Payoff_XYZ_left,
                                      data_straddle_center = Straddle_Payoff_XYZ_center,
                                      data_straddle_right = Straddle_Payoff_XYZ_right,
                                      data_distribution_overlay = Straddle_Payoff_Lognormal, 
                                      fill_rgb = col2rgb("cornflowerblue"),
                                      main_title = "A Straddle: Scenario 3",
                                      sub_title = "The market's view of the price of\nXYZ's shares on the expiry date.",
                                      curve_text_1 = "18.4%",
                                      curve_text_x_1 = 160,
                                      curve_text_y_1 = 4,
                                      curve_text_2 = "21.4%",
                                      curve_text_x_2 = 242.50, 
                                      curve_text_y_2 = 5)
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp; rm(temp)
```


## Theta

```{r XYZ-Theta-Over-Time-200, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260
Call_x <- seq(from = x_min, to = x_max, by = 0.1)
Theta_x <- rev( seq( from = 1, to = 2 * 252, by = 1 ) )

Call_price_high_vol <- bscall(s = 200, k = 200, v = 0.24, r = 0.02, tt = Theta_x/252, d = 0)
Call_cost_high_vol <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0, d = 0)
Call_payoff_high_vol <- Call_price_high_vol - Call_cost_high_vol
Call_theta_high_vol <- as.vector( greeks( bscall(s = 200, k = 200, v = 0.24, 
                                                 r = 0.02, tt = Theta_x/252, d = 0) )[6,] )

Call_price_medium_vol <- bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = Theta_x/252, d = 0)
Call_cost_medium_vol <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_payoff_medium_vol <- Call_price_medium_vol - Call_cost_medium_vol
Call_theta_medium_vol <- as.vector( greeks( bscall(s = 200, k = 200, v = 0.16, 
                                                   r = 0.02, tt = Theta_x/252, d = 0) )[6,] )

Call_price_low_vol <- bscall(s = 200, k = 200, v = 0.12, r = 0.02, tt = Theta_x/252, d = 0)
Call_cost_low_vol <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.5, d = 0)
Call_payoff_low_vol <- Call_price_low_vol - Call_cost_low_vol
Call_theta_low_vol <- as.vector( greeks( bscall(s = 200, k = 200, v = 0.12, 
                                                r = 0.02, tt = Theta_x/252, d = 0) )[6,] )

Call_Theta_XYZ_200_High_Vol <- tibble( "Theta_x" = Theta_x,
                                       "Price_y" = Call_price_high_vol,
                                       "Theta_y" = Call_theta_high_vol,
                                       "Color_High" = rep(TRUE, length(Theta_x)) )

Call_Theta_XYZ_200_Medium_Vol <- tibble( "Theta_x" = Theta_x,
                                         "Price_y" = Call_price_medium_vol,
                                         "Theta_y" = Call_theta_medium_vol,
                                         "Color_Med" = rep(TRUE, length(Theta_x)) )

Call_Theta_XYZ_200_Low_Vol <- tibble( "Theta_x" = Theta_x,
                                      "Price_y" = Call_price_low_vol,
                                      "Theta_y" = Call_theta_low_vol,
                                      "Color_Low" = rep(TRUE, length(Theta_x)) )

annotate_arrow_1 <- data.frame(x1 = 400, x2 = 400, y1 = 10, y2 = 14.5)
annotate_arrow_2 <- data.frame(x1 = 455, x2 = 460, y1 = 25, y2 = 21.5)
annotate_arrow_3 <- data.frame(x1 = 250, x2 = 250, y1 = 27.5, y2 = 22.5)

temp <- call_theta_over_time( call_theta_high_vol = Call_Theta_XYZ_200_High_Vol,
                              call_theta_medium_vol = Call_Theta_XYZ_200_Medium_Vol,
                              call_theta_low_vol = Call_Theta_XYZ_200_Low_Vol,
                              main_title = "Buy 1 XYZ call at the $200 strike",
                              sub_title = "Compare Theta Decay Over Time.") 

temp <- temp + scale_x_reverse() + 
        annotate( geom = "text", x = 435, y = 8.5, color = "gray35", hjust = 0,
                  label = paste0("Volatility: 25"), size = 4 ) +
        annotate( geom = "text", x = 450, y = 25, color = "purple", hjust = 0,
                  label = paste0("Volatility: 16"), size = 4 ) +
        annotate( geom = "text", x = 285, y = 29, color = "cornflowerblue", hjust = 0,
                  label = paste0("Volatility: 12"), size = 4 ) +
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray35" ) +
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "purple" ) +
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "cornflowerblue" )

temp; rm(temp)
```
