<!-- Each chapter is set to compile separately - include "global" set-up -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Source: https://davidgohel.github.io/officedown/articles/captions.html
knitr::opts_chunk$set(
  fig.cap.style = "Image Caption",
  fig.cap.pre = "", fig.cap.sep = "")

knitr::opts_chunk$set(
  tab.cap.style = "Table Caption",
  tab.cap.pre = "", tab.cap.sep = "")

CRAN_repo = getOption("repos")
CRAN_repo["CRAN"] = "http://cran.us.r-project.org"
options(repos = CRAN_repo)

if ( !require("here") )          { install.packages("here") };            require(here)
if ( !require("tidyverse") )     { install.packages("tidyverse") };       require(tidyverse)
if ( !require("ggtext") )        { install.packages("ggtext") };          require(ggtext)
if ( !require("pBrackets") )     { install.packages("pBrackets") };       require(pBrackets)
if ( !require("htmlwidgets") )   { install.packages("htmlwidgets") };     require(htmlwidgets)
if ( !require("plotly") )        { install.packages("plotly") };          require(plotly)
if ( !require("formattable") )   { install.packages("formattable") };     require(formattable)
if ( !require("kableExtra") )    { install.packages("kableExtra") };      require(kableExtra)
if ( !require("grid") )          { install.packages("grid") };            require(grid)
if ( !require("magick") )        { install.packages("magick") };          require(magick)
if ( !require("gridExtra") )     { install.packages("gridExtra") };       require(gridExtra)
if ( !require("derivmkts") )     { install.packages("derivmkts") };       require(derivmkts)

options(kableExtra.html.bsTable = TRUE)
options(kableExtra.auto_format = FALSE)

out_width_plot <- "97.5%"
out_width_table <- "97.5%"
grid::grid.locator(unit="npc") 

plot_bg <- "#FFFFFF"
plot_fg <- "#000000" 
plot_fg_alt <- "#969696" 

source("Plotting_Functions.R")
```

```{r Table-Helper-Functions}
at_least_number <- function(x,number) {
  ifelse( typeof(x) == "character", 
          return( as.numeric(gsub('\\(','-',gsub('[)$,]', '', x))) >= number ),
          return( x >= number) )
}

remove_negative_zeros <- function(x) { (x[which(-1e-4 < x & x < 1e-4)] = 0); return(x) }
```


# Thinking in Greeks I {#First-Greeks}

Payoff diagrams are fantastic visuals, but the ones we have looked at only tell us about the performance of the option on its expiry date. If we're interested in earlier dates, we need to upgrade the payoff diagram. That's our task in this chapter.


## Delta

Here is one of the first payoff diagrams we saw. It shows us when we'll lose money, when we'll make money, and when we'll switch from losing money to making money. But it tells us even more -- it gives us the *delta* of our investment.

```{r Stock-Demo-Revisted, echo=FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE}
Stock_cost <- 200
x_min = 160; x_max = 240

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit","Loss") )

s1 <- bracketsGrob(0.25, 0.25, 0.25, 0.5, lwd=2, col="red")
s2 <- bracketsGrob(0.75, 0.75, 0.75, 0.5, lwd=2, col="green3")

### Source: https://stackoverflow.com/questions/35633239/add-curly-braces-to-ggplot2-and-then-use-ggsave
temp <- stock_payoff(Stock_Payoff_XYZ, main_title = "Buy shares at $200")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( y_axis_labels < 0, "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
     # annotate( geom = "text", x = 160, y = -12, color = "red", hjust = 0, 
     #           label = paste0("Losses"), size = 5 ) + 
     # annotate( geom = "text", x = 231, y = 12, color = "green3", hjust = 0, 
     #           label = paste0("Profits"), size = 5 ) + 
     annotate( geom = "text", x = Stock_cost-7.5, y = min(y_axis_labels), color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost)), size = 4 ) + 
     annotate( geom = "text", x = Stock_cost-7.5, y = min(y_axis_labels), color = "red", hjust = 0,
               label = "Breakev", size = 4 ) 
     # annotation_custom( s1 ) + annotation_custom( s2 ) 

temp; rm(temp)
```
*Delta* is how much we participate in a stock moving up or down. If we own the stock, we make `r currency(1)` for every `r currency(1)` the stock goes up, and we lose `r currency(1)` for every `r currency(1)` the stock goes down. We call a stock a *delta one* asset as a shorthand way of describing this dollar-for-dollar relationship. 

We've spent lots of time talking about how options participate dollar-for-dollar in the performance of their stock once they're above their strike price, on their expiry day. As a quick refresher, we looked at this call option. Below it's strike price of \$200, the call expires worthless. It doesn't go up or down in price -- it has a delta of zero. Above it's strike price, it participates dollar-for-dollar in the stock's price movements -- it has a delta of one. 

```{r Call-Option-Payoff-Plot, out.width = out_width_plot, fig.align = "center", message = FALSE}
Call_cost <- 15; Call_K <- 200
x_min <- 140; x_max = 280

Call_Payoff_XYZ_200 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit","Loss") )

c1 <- bracketsGrob(0.25, 0.10, 0.25, 0.255, lwd=2, col="red")
c2 <- bracketsGrob(0.80, 0.69, 0.80, 0.255, lwd=2, col="green3")

temp <- call_payoff(data = Call_Payoff_XYZ_200, main_title = "Buy 1 call at the $200 strike")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
     # annotate( geom = "text", x = 145, y = -7, color = "red", hjust = 0, 
     #           label = paste0("Losses"), size = 5 ) + 
     # annotate( geom = "text", x = 270, y = 20.5, color = "green3", hjust = 0, 
     #           label = paste0("Profits"), size = 5 ) + 
     annotate( geom = "text", x = Call_K+Call_cost-14, y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost)), size = 4 ) + 
     annotate( geom = "text", x = Call_K+Call_cost-14, y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) 
     # annotation_custom( c1 ) + annotation_custom( c2 ) 

temp; rm(temp)
```

Try not to confuse the strike price of `r currency(200)` with the breakeven of `r currency(215)`. For a call, the strike price is the price you have the option of buying the shares at. These calls cost `r currency(15)`, so we have to make `r currency(15)` back to get to breakeven before the call becomes profitable. But we start going up dollar-for-dollar at `r currency (200)` to make that `r currency (15)` back at `r currency (215)`. 

We've seen stocks, which are delta one. And we've seen calls on their expiry date, which have a delta of zero below their strike price and a delta of one above their strike price. What about the payoffs of calls (and puts) before their expiry date? It depends on how far they are from expiring. We'll explore this by looking at the payoff diagram of the `r currency(200)` strike call 3, 6, and 12 months before it's expiry date. 

Before we get into it, a quick note -- the cost of a call varies depending on how far away from expiry it is. The intuition is that the closer the `r currency(200)` strike call gets to expiring, the less time the stock has to go up. So it loses (time) value every day. We'll get into the details of how that works when we talk about *theta* and *vega* in the next chapter. For now, suppose we bought the call for `r currency(15)`, and that we hold it until it is 3, 6, or 12 months from expiry. 

```{r XYZ-Delta-3-Months-Before-Expiry-200, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260

Call_x <- seq(from = x_min, to = x_max, by = 0.1)
Call_price <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_cost <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_payoff <- Call_price - Call_cost
Call_delta <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                             r = 0.02, tt = 0.25, d = 0) )[2,] 

idx_1 <- which(Call_x == 160)
tangent_line_1 <- Call_delta[idx_1] * Call_x
tangent_line_1 <- tangent_line_1 - tangent_line_1[idx_1] + Call_payoff[idx_1]

idx_2 <- which(Call_x == Call_K)
tangent_line_2 <- Call_delta[idx_2] * Call_x 
tangent_line_2 <- tangent_line_2 - tangent_line_2[idx_2] + Call_payoff[idx_2]

idx_3 <- which(Call_x == 240)
tangent_line_3 <- Call_delta[idx_3] * Call_x
tangent_line_3 <- tangent_line_3 - tangent_line_3[idx_3] + Call_payoff[idx_3]


Call_Payoff_XYZ_200_3months <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 0.1)),
                       "Call_payoff" = currency(Call_payoff), 
                       "Call_delta_first" = currency(tangent_line_1),
                       "Call_delta_second" = currency(tangent_line_2),
                       "Call_delta_third" = currency(tangent_line_3),
                       "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                             "Profit_call","Loss_call"),
                       "Delta_first" = ifelse( abs(Call_x-160) < 5,"Show_delta_first","Hide_delta_first"), 
                       "Delta_second" = ifelse( abs(Call_x-200) < 5, "Show_delta_second","Hide_delta_second"), 
                       "Delta_third" = ifelse( abs(Call_x-240) < 5, "Show_delta_third","Hide_delta_third") )

Call_Payoff_XYZ_200_expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

annotate_arrow_1 <- data.frame(x1 = 160, x2 = 160, y1 = 0, y2 = -10)
annotate_arrow_2 <- data.frame(x1 = 200-1, x2 = 200-1, y1 = 7.5, y2 = -2.5)
annotate_arrow_3 <- data.frame(x1 = 240-2.5, x2 = 240-2.5, y1 = 42.5, y2 = 32.5)


temp <- call_delta_before_expiry_payoff( data_call_before_expiry = Call_Payoff_XYZ_200_3months, 
                                         data_call_on_expiry = Call_Payoff_XYZ_200_expiry,
                                         main_title = "Buy 1 call at the $200 strike",
                                         sub_title = "Payoff 3 months before expiry (solid line) vs. \nPayoff at expiry (dotted line).")

temp <- temp + scale_y_continuous(label = scales::dollar, limits = c(-20,60))

y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0, "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
        annotate( geom = "text", x = 150, y = 7.5, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $160\nDelta: 0.009"), size = 4 ) + 
        annotate( geom = "text", x = 190, y = 15, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $200\nDelta: 0.540"), size = 4 ) +
        annotate( geom = "text", x = 227.5, y = 50, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $240\nDelta: 0.984"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = -20, color = "green3", hjust = 0,
                  label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost)), size = 4 ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = -20, color = "red", hjust = 0,
                  label = "Breakev", size = 4 ) 

temp; rm(temp)
```

Add.

```{r XYZ-Delta-6-Months-Before-Expiry-200, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260

Call_x <- seq(from = x_min, to = x_max, by = 0.1)
Call_price <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0.5, d = 0)
Call_cost <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.5, d = 0)
Call_payoff <- Call_price - Call_cost
Call_delta <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                             r = 0.02, tt = 0.5, d = 0) )[2,] 

idx_1 <- which(Call_x == 160)
tangent_line_1 <- Call_delta[idx_1] * Call_x
tangent_line_1 <- tangent_line_1 - tangent_line_1[idx_1] + Call_payoff[idx_1]

idx_2 <- which(Call_x == Call_K)
tangent_line_2 <- Call_delta[idx_2] * Call_x 
tangent_line_2 <- tangent_line_2 - tangent_line_2[idx_2] + Call_payoff[idx_2]

idx_3 <- which(Call_x == 240)
tangent_line_3 <- Call_delta[idx_3] * Call_x
tangent_line_3 <- tangent_line_3 - tangent_line_3[idx_3] + Call_payoff[idx_3]


Call_Payoff_XYZ_200_6months <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 0.1)),
                       "Call_payoff" = currency(Call_payoff), 
                       "Call_delta_first" = currency(tangent_line_1),
                       "Call_delta_second" = currency(tangent_line_2),
                       "Call_delta_third" = currency(tangent_line_3),
                       "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                             "Profit_call","Loss_call"),
                       "Delta_first" = ifelse( abs(Call_x-160) < 5,"Show_delta_first","Hide_delta_first"), 
                       "Delta_second" = ifelse( abs(Call_x-200) < 5, "Show_delta_second","Hide_delta_second"), 
                       "Delta_third" = ifelse( abs(Call_x-240) < 5, "Show_delta_third","Hide_delta_third") )

Call_Payoff_XYZ_200_expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

annotate_arrow_1 <- data.frame(x1 = 160, x2 = 160, y1 = 0, y2 = -10)
annotate_arrow_2 <- data.frame(x1 = 200-1, x2 = 200-1, y1 = 7.5, y2 = -2.5)
annotate_arrow_3 <- data.frame(x1 = 240-2.5, x2 = 240-2.5, y1 = 42.5, y2 = 32.5)


temp <- call_delta_before_expiry_payoff( data_call_before_expiry = Call_Payoff_XYZ_200_6months, 
                                         data_call_on_expiry = Call_Payoff_XYZ_200_expiry,
                                         main_title = "Buy 1 call at the $200 strike",
                                         sub_title = "Payoff 6 months before expiry (solid line) vs. \nPayoff at expiry (dotted line).")

temp <- temp + scale_y_continuous(label = scales::dollar, limits = c(-20,60)) 

y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0, "red", "green3" )
  
temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
        annotate( geom = "text", x = 150, y = 7.5, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $160\nDelta: 0.054"), size = 4 ) + 
        annotate( geom = "text", x = 190, y = 15, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $200\nDelta: 0.557"), size = 4 ) +
        annotate( geom = "text", x = 227.5, y = 50, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $240\nDelta: 0.942"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = -20, color = "green3", hjust = 0,
                  label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost)), size = 4 ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = -20, color = "red", hjust = 0,
                  label = "Breakev", size = 4 ) 

temp; rm(temp)
```
Add.

```{r XYZ-Delta-12-Months-Before-Expiry-200, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260

Call_x <- seq(from = x_min, to = x_max, by = 0.1)
Call_price <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 1, d = 0)
Call_cost <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 1, d = 0)
Call_payoff <- Call_price - Call_cost
Call_delta <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                             r = 0.02, tt = 1, d = 0) )[2,] 

idx_1 <- which(Call_x == 160)
tangent_line_1 <- Call_delta[idx_1] * Call_x
tangent_line_1 <- tangent_line_1 - tangent_line_1[idx_1] + Call_payoff[idx_1]

idx_2 <- which(Call_x == Call_K)
tangent_line_2 <- Call_delta[idx_2] * Call_x 
tangent_line_2 <- tangent_line_2 - tangent_line_2[idx_2] + Call_payoff[idx_2]

idx_3 <- which(Call_x == 240)
tangent_line_3 <- Call_delta[idx_3] * Call_x
tangent_line_3 <- tangent_line_3 - tangent_line_3[idx_3] + Call_payoff[idx_3]


Call_Payoff_XYZ_200_12months <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 0.1)),
                       "Call_payoff" = currency(Call_payoff), 
                       "Call_delta_first" = currency(tangent_line_1),
                       "Call_delta_second" = currency(tangent_line_2),
                       "Call_delta_third" = currency(tangent_line_3),
                       "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                             "Profit_call","Loss_call"),
                       "Delta_first" = ifelse( abs(Call_x-160) < 5,"Show_delta_first","Hide_delta_first"), 
                       "Delta_second" = ifelse( abs(Call_x-200) < 5, "Show_delta_second","Hide_delta_second"), 
                       "Delta_third" = ifelse( abs(Call_x-240) < 5, "Show_delta_third","Hide_delta_third") )

Call_Payoff_XYZ_200_expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

annotate_arrow_1 <- data.frame(x1 = 159.5, x2 = 159.5, y1 = 5, y2 = -10)
annotate_arrow_2 <- data.frame(x1 = 199.5, x2 = 199.5, y1 = 12.5, y2 = 2.5)
annotate_arrow_3 <- data.frame(x1 = 237.5, x2 = 237.5, y1 = 47.5, y2 = 35)


temp <- call_delta_before_expiry_payoff( data_call_before_expiry = Call_Payoff_XYZ_200_12months, 
                                         data_call_on_expiry = Call_Payoff_XYZ_200_expiry,
                                         main_title = "Buy 1 call at the $200 strike",
                                         sub_title = "Payoff 12 months before expiry (solid line) vs. \nPayoff at expiry (dotted line).")

temp <- temp + scale_y_continuous(label = scales::dollar, limits = c(-20,60)) 

y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0, "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
        annotate( geom = "text", x = 150, y = 12.5, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $160\nDelta: 0.150"), size = 4 ) + 
        annotate( geom = "text", x = 192.5, y = 20, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $200\nDelta: 0.580"), size = 4 ) +
        annotate( geom = "text", x = 227.5, y = 55, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $240\nDelta: 0.888"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = -20, color = "green3", hjust = 0,
                  label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost)), size = 4 ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = -20, color = "red", hjust = 0,
                  label = "Breakev", size = 4 ) 

temp; rm(temp)
```
Add.
<!-- There's also a broader risk-reward story here. The payoff goes up faster and faster as the stock goes up, so we make money faster and faster. The flip side of that is that the payoff goes down slower and slower as the stock falls, so we lose money slower and slower. *Delta* and *gamma* try to describe this effect with numbers, but most of us won't be using *delta* or *gamma* to aggressively risk-manage positions the way a hedge fund or an algorithm would. That's too complicated and time-consuming for most of us. -->

```{r XYZ-Delta-Over-Time-200, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260
Call_x <- seq(from = x_min, to = x_max, by = 0.1)

Call_price_on_expiry <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0, d = 0)
Call_cost_on_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0, d = 0)
Call_payoff_on_expiry <- Call_price_on_expiry - Call_cost_on_expiry
Call_delta_on_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                       r = 0.02, tt = 0, d = 0) )[2,] 

Call_price_3months_expiry <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_cost_3months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_payoff_3months_expiry <- Call_price_3months_expiry - Call_cost_3months_expiry
Call_delta_3months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                            r = 0.02, tt = 0.25, d = 0) )[2,] 

Call_price_6months_expiry <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0.5, d = 0) 
Call_cost_6months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.5, d = 0)
Call_payoff_6months_expiry <- Call_price_6months_expiry - Call_cost_6months_expiry
Call_delta_6months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                            r = 0.02, tt = 0.5, d = 0) )[2,] 

Call_price_12months_expiry <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 1, d = 0)
Call_cost_12months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 1, d = 0)
Call_payoff_12months_expiry <- Call_price_12months_expiry - Call_cost_12months_expiry
Call_delta_12months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                             r = 0.02, tt = 1, d = 0) )[2,] 

Call_Delta_XYZ_200_On_Expiry <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 0.1)),
                       "Delta_y" = Call_delta_on_expiry, 
                       "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                             "Profit_call","Loss_call") )

Call_Delta_XYZ_200_3months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Delta_y" = Call_delta_3months_expiry,
                               "Profitable" = ifelse(-Call_cost_3months_expiry + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Call_Delta_XYZ_200_6months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Delta_y" = Call_delta_6months_expiry,
                               "Profitable" = ifelse(-Call_cost_6months_expiry + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Call_Delta_XYZ_200_12months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Delta_y" = Call_delta_12months_expiry,
                               "Profitable" = ifelse(-Call_cost_12months_expiry + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

annotate_arrow_1 <- data.frame(x1 = 187.5, x2 = 197.5, y1 = 0.80, y2 = 0.80)
annotate_arrow_2 <- data.frame(x1 = 190, x2 = 190, y1 = 0.175, y2 = 0.275)
annotate_arrow_3 <- data.frame(x1 = 240, x2 = 240, y1 = 0.75, y2 = 0.85)

temp <- call_delta_over_time( call_delta_on_expiry = Call_Delta_XYZ_200_On_Expiry, 
                              call_delta_3months_expiry = Call_Delta_XYZ_200_3months_Expiry,
                              # call_delta_6months_expiry = Call_Delta_XYZ_200_6months_Expiry,
                              call_delta_12months_expiry = Call_Delta_XYZ_200_12months_Expiry,
                              main_title = "Buy 1 call at the $200 strike",
                              sub_title = "Compare Call Delta Across Time.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))

temp <- temp + 
        annotate( geom = "text", x = 171, y = 0.80, color = "gray50", hjust = 0, 
                  label = paste0("On expiry"), size = 4 ) + 
        annotate( geom = "text", x = 183, y = 0.10, color = "gray50", hjust = 0, 
                  label = paste0("3 months\nfrom expiry"), size = 4 ) +
        annotate( geom = "text", x = 232.5, y = 0.675, color = "gray50", hjust = 0, 
                  label = paste0("12 months\nfrom expiry"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = 0, color = "green3", hjust = 0,
                  label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost)), size = 4 ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = 0, color = "red", hjust = 0,
                  label = "Breakev", size = 4 ) 

temp; rm(temp)
```

We're going to use our knowledge of *delta* and *gamma* to construct favorable trades, and to effectively risk-manage them once we go over the three remaining greeks. Before we move on to *vega*, I want to emphasis that this call's payoff diagram (before expiry) is still *asymmetric*. It's not the all-or-nothing setup we saw in the first two chapters, and we don't quite get dollar-for-dollar participation to the upside. It took an almost \$15 move to the upside in XYZ's stock to get close to that. But there's still asymmetry: we make more and more money as the stock goes up, and lose less and less money as the stock goes down. In one way or another, all options strategies boil down to trying to exploit that asymmetry. 


## Gamma

*Gamma* tells us how quickly our participation in the price movements of the stock changes. For example, the *delta* of the option 12 months from expiry changes more slowly as XYZ's shares increase than the option that is 3 months from expiry. We can look at how quickly the *delta* is changing to get a sense of *gamma*. 

```{r XYZ-Gamma-3-Months-Before-Expiry, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260
Call_x <- seq(from = x_min, to = x_max, by = 0.1)

Call_price_on_expiry <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0, d = 0)
Call_cost_on_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0, d = 0)
Call_payoff_on_expiry <- Call_price_on_expiry - Call_cost_on_expiry
Call_delta_on_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                       r = 0.02, tt = 0, d = 0) )[2,] 

Call_price_3months_expiry <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_cost_3months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_payoff_3months_expiry <- Call_price_3months_expiry - Call_cost_3months_expiry
Call_delta_3months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                            r = 0.02, tt = 0.25, d = 0) )[2,] 
Call_gamma_3months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                            r = 0.02, tt = 0.25, d = 0) )[3,] 


idx_1 <- which(Call_x == 160)
tangent_line_1 <- Call_gamma_3months_expiry[idx_1] * Call_x
tangent_line_1 <- tangent_line_1 - tangent_line_1[idx_1] + Call_delta_3months_expiry[idx_1]

idx_2 <- which(Call_x == Call_K)
tangent_line_2 <- Call_gamma_3months_expiry[idx_2] * Call_x 
tangent_line_2 <- tangent_line_2 - tangent_line_2[idx_2] + Call_delta_3months_expiry[idx_2]

idx_3 <- which(Call_x == 240)
tangent_line_3 <- Call_gamma_3months_expiry[idx_3] * Call_x
tangent_line_3 <- tangent_line_3 - tangent_line_3[idx_3] + Call_delta_3months_expiry[idx_3]


Call_Delta_XYZ_200_On_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Call_delta" = Call_delta_on_expiry,         
                               "Profitable" = ifelse(-Call_cost_on_expiry + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Call_Delta_XYZ_200_3months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Call_delta" = Call_delta_3months_expiry, 
                               "Gamma_y" = Call_gamma_3months_expiry,
                               "Call_gamma_first" = tangent_line_1,
                               "Call_gamma_second" = tangent_line_2,
                               "Call_gamma_third" = tangent_line_3,
                               "Profitable" = ifelse(-Call_cost_3months_expiry + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call"),
                               "Gamma_first" = ifelse( abs(Call_x-160) < 5,"Show_gamma_first","Hide_gamma_first"), 
                               "Gamma_second" = ifelse( abs(Call_x-200) < 3.5, "Show_gamma_second","Hide_gamma_second"), 
                               "Gamma_third" = ifelse( abs(Call_x-240) < 5, "Show_gamma_third","Hide_gamma_third") )

annotate_arrow_1 <- data.frame(x1 = 160, x2 = 160, y1 = 0.15, y2 = 0.05)
annotate_arrow_2 <- data.frame(x1 = 187.5, x2 = 195, y1 = 0.65, y2 = 0.55)
annotate_arrow_3 <- data.frame(x1 = 240, x2 = 240, y1 = 0.85, y2 = 0.95)

temp <- call_gamma_before_expiry_payoff( call_delta_before_expiry = Call_Delta_XYZ_200_3months_Expiry,
                             call_delta_on_expiry = Call_Delta_XYZ_200_On_Expiry,
                             main_title = "Buy 1 call at the $200 strike",
                             sub_title = "Delta 3 months before expiry (solid line) vs. \nDelta at expiry (dotted line).")

temp <- temp + ylim(-0.01,1.01) + 
        annotate( geom = "text", x = 150, y = 0.25, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $160\nGamma: 0.0008"), size = 4 ) + 
        annotate( geom = "text", x = 175, y = 0.75, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $200\nGamma: 0.0248"), size = 4 ) +
        annotate( geom = "text", x = 232.5, y = 0.75, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $240\nGamma: 0.0012"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = 0, color = "green3", hjust = 0,
                  label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost)), size = 4 ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = 0, color = "red", hjust = 0,
                  label = "Breakev", size = 4 ) 

temp; rm(temp)
```

Another gamma plot. 

```{r XYZ-Gamma-12-Months-Before-Expiry, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260
Call_x <- seq(from = x_min, to = x_max, by = 0.1)

Call_price_on_expiry <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0, d = 0)
Call_cost_on_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0, d = 0)
Call_payoff_on_expiry <- Call_price_on_expiry - Call_cost_on_expiry
Call_delta_on_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                       r = 0.02, tt = 0, d = 0) )[2,] 

Call_price_12months_expiry <- sapply(Call_x, function(x) { bscall(s = x, k = 200, v = 0.16, r = 0.02, tt = 1, d = 0) })
Call_cost_12months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_payoff_12months_expiry <- Call_price_12months_expiry - Call_cost_12months_expiry
Call_delta_12months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                             r = 0.02, tt = 1, d = 0) )[2,] 
Call_gamma_12months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                             r = 0.02, tt = 1, d = 0) )[3,] 


idx_1 <- which(Call_x == 160)
tangent_line_1 <- Call_gamma_12months_expiry[idx_1] * Call_x
tangent_line_1 <- tangent_line_1 - tangent_line_1[idx_1] + Call_delta_12months_expiry[idx_1]

idx_2 <- which(Call_x == Call_K)
tangent_line_2 <- Call_gamma_12months_expiry[idx_2] * Call_x 
tangent_line_2 <- tangent_line_2 - tangent_line_2[idx_2] + Call_delta_12months_expiry[idx_2]

idx_3 <- which(Call_x == 240)
tangent_line_3 <- Call_gamma_12months_expiry[idx_3] * Call_x
tangent_line_3 <- tangent_line_3 - tangent_line_3[idx_3] + Call_delta_12months_expiry[idx_3]


Call_Delta_XYZ_200_On_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Call_delta" = Call_delta_on_expiry,         
                               "Profitable" = ifelse(-Call_cost_on_expiry + 
                                                       (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Call_Delta_XYZ_200_12months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Call_delta" = Call_delta_12months_expiry, 
                               "Gamma_y" = Call_gamma_12months_expiry,
                               "Call_gamma_first" = tangent_line_1,
                               "Call_gamma_second" = tangent_line_2,
                               "Call_gamma_third" = tangent_line_3,
                               "Profitable" = ifelse(-Call_cost_3months_expiry + 
                                                       (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call"),
                               "Gamma_first" = ifelse( abs(Call_x-160) < 5,"Show_gamma_first","Hide_gamma_first"), 
                               "Gamma_second" = ifelse( abs(Call_x-200) < 4.5, "Show_gamma_second","Hide_gamma_second"), 
                               "Gamma_third" = ifelse( abs(Call_x-240) < 5, "Show_gamma_third","Hide_gamma_third") )

annotate_arrow_1 <- data.frame(x1 = 160, x2 = 160, y1 = 0.275, y2 = 0.16)
annotate_arrow_2 <- data.frame(x1 = 187.5, x2 = 197.5, y1 = 0.70, y2 = 0.60)
annotate_arrow_3 <- data.frame(x1 = 241, x2 = 241, y1 = 0.75, y2 = 0.875)

temp <- call_gamma_before_expiry_payoff( call_delta_before_expiry = Call_Delta_XYZ_200_12months_Expiry,
                             call_delta_on_expiry = Call_Delta_XYZ_200_On_Expiry,
                             main_title = "Buy 1 call at the $200 strike",
                             sub_title = "Delta 12 months before expiry (solid line) vs. \nDelta at expiry (dotted line).")

temp <- temp + 
        annotate( geom = "text", x = 150, y = 0.375, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $160\nGamma: 0.0008"), size = 4 ) + 
        annotate( geom = "text", x = 175, y = 0.80, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $200\nGamma: 0.0248"), size = 4 ) +
        annotate( geom = "text", x = 232.5, y = 0.65, color = "gray50", hjust = 0, 
                  label = paste0("Stock: $240\nGamma: 0.0012"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = -20, color = "green3", hjust = 0,
                  label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost)), size = 4 ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = -20, color = "red", hjust = 0,
                  label = "Breakev", size = 4 ) 

temp; rm(temp)
```

The final gamma plot

```{r XYZ-Gamma-Over-Time-200, echo = FALSE, out.width = out_width_plot, fig.align = "center", message = FALSE, warning = FALSE}
Call_K <- 200
Current_price <- 200
x_min = 140; x_max = 260
Call_x <- seq(from = x_min, to = x_max, by = 0.1)

Call_price_on_expiry <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0, d = 0)
Call_cost_on_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0, d = 0)
Call_payoff_on_expiry <- Call_price_on_expiry - Call_cost_on_expiry
Call_delta_on_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                       r = 0.02, tt = 0, d = 0) )[2,] 
Call_gamma_on_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                       r = 0.02, tt = 1e-5, d = 0) )[3,] 

Call_price_3months_expiry <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_cost_3months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.25, d = 0)
Call_payoff_3months_expiry <- Call_price_3months_expiry - Call_cost_3months_expiry
Call_delta_3months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                            r = 0.02, tt = 0.25, d = 0) )[2,] 
Call_gamma_3months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                            r = 0.02, tt = 0.25, d = 0) )[3,] 

Call_price_6months_expiry <- bscall(s = Call_x, k = 200, v = 0.16, r = 0.02, tt = 0.5, d = 0)
Call_cost_6months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 0.5, d = 0)
Call_payoff_6months_expiry <- Call_price_6months_expiry - Call_cost_6months_expiry
Call_delta_6months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                            r = 0.02, tt = 0.5, d = 0) )[2,] 
Call_gamma_6months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                            r = 0.02, tt = 0.5, d = 0) )[3,] 

Call_price_12months_expiry <- sapply(Call_x, function(x) { bscall(s = x, k = 200, v = 0.16, r = 0.02, tt = 1, d = 0) })
Call_cost_12months_expiry <- 15 # bscall(s = 200, k = 200, v = 0.16, r = 0.02, tt = 1, d = 0)
Call_payoff_12months_expiry <- Call_price_12months_expiry - Call_cost_12months_expiry
Call_delta_12months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                             r = 0.02, tt = 1, d = 0) )[2,] 
Call_gamma_12months_expiry <- greeks( bscall(s = Call_x, k = 200, v = 0.16, 
                                             r = 0.02, tt = 1, d = 0) )[3,] 

Call_Gamma_XYZ_200_On_Expiry <- tibble( "Call_x" = currency(seq(from = x_min, to = x_max, by = 0.1)),
                       "Delta_y" = Call_gamma_on_expiry, 
                       "Profitable" = ifelse(-Call_cost_on_expiry + 
                                               (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                             "Profit_call","Loss_call") )

Call_Gamma_XYZ_200_3months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Delta_y" = Call_gamma_3months_expiry,
                               "Profitable" = ifelse(-Call_cost_3months_expiry + 
                                                       (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Call_Gamma_XYZ_200_6months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Delta_y" = Call_gamma_6months_expiry,
                               "Profitable" = ifelse(-Call_cost_6months_expiry + 
                                                       (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Call_Gamma_XYZ_200_12months_Expiry <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.1),
                               "Delta_y" = Call_gamma_12months_expiry,
                               "Profitable" = ifelse(-Call_cost_12months_expiry + 
                                                       (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

annotate_arrow_1 <- data.frame(x1 = 212.5, x2 = 202.5, y1 = 0.04, y2 = 0.04)
annotate_arrow_2 <- data.frame(x1 = 175, x2 = 182.5, y1 = 0.025, y2 = 0.019)
annotate_arrow_3 <-   data.frame(x1 = 147, x2 = 147, y1 = 0.015, y2 = 0.006)

temp <- call_gamma_over_time( call_gamma_on_expiry = Call_Gamma_XYZ_200_On_Expiry, 
                              call_gamma_3months_expiry = Call_Gamma_XYZ_200_3months_Expiry,
                              call_gamma_12months_expiry = Call_Gamma_XYZ_200_12months_Expiry,
                              main_title = "Buy 1 call at the $200 strike",
                              sub_title = "Compare Call Gamma Across Time.")

temp <- temp + 
        annotate( geom = "text", x = 207.5, y = 0.0375, color = "gray50", hjust = 0, 
                  label = paste0("On expiry"), size = 4 ) + 
        annotate( geom = "text", x = 167.5, y = 0.03, color = "gray50", hjust = 0, 
                  label = paste0("3 months\nfrom expiry"), size = 4 ) +
        annotate( geom = "text", x = 140, y = 0.020, color = "gray50", hjust = 0, 
                  label = paste0("12 months\nfrom expiry"), size = 4 ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                    arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = 0.002, color = "green3", hjust = 0,
                  label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost)), size = 4 ) + 
        annotate( geom = "text", x = Call_K+Call_cost-11, y = 0.002, color = "red", hjust = 0,
                  label = "Breakev", size = 4 ) 

temp; rm(temp)
```

