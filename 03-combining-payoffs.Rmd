<!-- Each chapter is set to compile separately - include "global" set-up -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

CRAN_repo = getOption("repos")
CRAN_repo["CRAN"] = "http://cran.us.r-project.org"
options(repos = CRAN_repo)

if ( !require("here") )          { install.packages("here") };            require(here)
if ( !require("tidyverse") )     { install.packages("tidyverse") };       require(tidyverse)
if ( !require("ggtext") )        { install.packages("ggtext") };          require(ggtext)
if ( !require("pBrackets") )     { install.packages("pBrackets") };       require(pBrackets)
if ( !require("htmlwidgets") )   { install.packages("htmlwidgets") };     require(htmlwidgets)
if ( !require("plotly") )        { install.packages("plotly") };          require(plotly)
if ( !require("formattable") )   { install.packages("formattable") };     require(formattable)
if ( !require("kableExtra") )    { install.packages("kableExtra") };      require(kableExtra)
if ( !require("rtsdata") )       { install.packages("rtsdata") };         require(rtsdata)
if ( !require("PerformanceAnalytics") )     { install.packages("PerformanceAnalytics") };   require(PerformanceAnalytics)
if ( !require("anytime") )       { install.packages("anytime") };         require(anytime)
if ( !require("nor1mix") )       { install.packages("nor1mix") };         require(nor1mix)

options(kableExtra.html.bsTable = TRUE)
options(kableExtra.auto_format = FALSE)

out_width_plot <- "97.5%"
out_width_table <- "97.5%"
grid::grid.locator(unit="npc") 

plot_bg <- "#FFFFFF"
plot_fg <- "#000000" 
plot_fg_alt <- "#969696" 

source("Plotting_Functions.R")
```

```{r Table-Helper-Functions}
at_least_number <- function(x,number) {
  ifelse( typeof(x) == "character", 
          return( as.numeric(gsub('\\(','-',gsub('[)$,]', '', x))) >= number ),
          return( x >= number) )
}

remove_negative_zeros <- function(x) { (x[which(-1e-4 < x & x < 1e-4)] = 0); return(x) }
```

# Building Options Strategies

We can do a lot more with options than just buying or selling one put or one call. Stocks, calls, and puts are the basic building blocks that we can combine to construct investments with any payoff structure we want. There are tons of options strategies, and they're all just combinations of these building blocks. You don't need to know their names to understand their strengths and weaknesses, and the goal of this chapter is to show you how to construct options strategies on-the-fly that have the payoff that you want. In the next few chapters, we'll talk about the greeks, which will let us understand how options change price before their expiry date. They're the tool we need before we can consider payoff diagrams before expiry dates. For now, let's nail down how to construct payoff diagrams for strategies on expiry dates. 

## Protective Put

A protective put combines owning shares of a stock with buying puts on the same stock. The goal of this strategy is protect the stock position against potentially large losses. The payoff diagram has two dotted lines. The first shows buying a put at the \$180 strike for \$16/share. The second shows buying 1 share at \$200. The solid line, the protective put, combines the two dotted lines.

```{r XYZ-Protective-Put, fig.align = "center", out.width = out_width_plot, message = FALSE}
Put_cost <- 16; Put_K <- 180
Stock_cost <- 200
x_min <- 120; x_max = 280

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Put_Payoff_XYZ_180 <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                              "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                              "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                    "Profit_put", "Loss_put") )

Protective_Put_Payoff_XYZ <- tibble( "Protective_Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Protective_Put_y" = -Put_cost - (Protective_Put_x < Put_K) * (Protective_Put_x - Put_K) + 
                                                  seq(from = x_min, to = x_max, by = 0.01) - Stock_cost,
                            "Profitable" = ifelse( ( -Put_cost - (Protective_Put_x < Put_K) * (Protective_Put_x - Put_K) + 
                                                  seq(from = x_min, to = x_max, by = 0.01) - Stock_cost) > 0, 
                                                  "Profit_protective_put","Loss_protective_put") )


sl1 <- bracketsGrob(0.25, 0.30, 0.25, 0.50, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.625, 0.725, 0.50, lwd=2, col="green3")

annotate_arrow_1 <- data.frame(x1 = 150, x2 = 140, y1 = 35, y2 = 30)
annotate_arrow_2 <- data.frame(x1 = 225, x2 = 235, y1 = 50, y2 = 45)

temp <- protective_put_payoff(data_protective_put = Protective_Put_Payoff_XYZ,
                              data_stock = Stock_Payoff_XYZ, data_put = Put_Payoff_XYZ_180,
                              main_title = "Protective Put",
                              sub_title = "" )
                              # sub_title = "Buy 100 shares at $200/share\nBuy 1 put for $16/share at the $180 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) +
     # annotate( geom = "text", x = 125, y = -15, color = "red", hjust = 0,
     #           label = paste0("Losses"), size = 5 ) +
     # annotate( geom = "text", x = 255, y = 10, color = "green3", hjust = 0,
     #           label = paste0("Profits"), size = 5 ) +
     annotate( geom = "text", x = Put_cost + Stock_cost - 15, 
               y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Put_cost + Stock_cost)), size = 4 ) +
     annotate( geom = "text", x = Put_cost + Stock_cost - 15, 
               y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +
     # annotation_custom( sl1 ) + annotation_custom( sl2 ) + 
     annotate( geom = "text", x = 152.5, y = 35, color = "gray50", hjust = 0, 
               label = paste0("Put"), size = 4 ) +
     annotate( geom = "text", x = 215, y = 59, color = "gray50", hjust = 0, 
               label = paste0("Shares"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate( geom = "text", x = 175-16, y = 7.5, color = "gray50", hjust = 0,
                  label = paste0("$164"), size = 3.5 ) +
     annotate("point", x = 180-16, y = 0, colour = "gray50") + 
     annotate( geom = "text", x = 195, y = 7.5, color = "gray50", hjust = 0,
                  label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 200, y = 0, colour = "gray50") 

temp; rm(temp)
```
Let's look at the \$180 strike put first. It goes up dollar-for-dollar as the stock falls below \$180. The stock (always) goes up dollar-for-dollar, so below \$180 the put and stock cancel each other. The protective put captures this, as it is flat below \$180. Above \$180, the put's payoff does not change while the stock goes up dollar-for-dollar. The protective put goes up dollar-for-dollar above \$180, but is parallel to the stock because the put cost \$16. This makes the payoff of the protective payoff \$16 less than the stock (which is also reflected in its higher breakeven of \$216 = \$200 + \$16, which has to recover this \$16 before becoming profitable).

The takeaway is that we can use a put to "cancel out" losses from buying shares that are below the strike price of the put (on the expiry date of the put). Also, breaking up the payoff diagram based on the behavior of the options we're considering is a fundamental strategy that we'll be repeating every time we encounter a new options strategy. It will be more familiar over time, and let you construct trades with your desired payoff structure relatively easily. 

A cautionary note: the payoff diagram doesn't capture how likely these two outcomes are. They're uncertain future outcomes and we don't know which one will happen ahead of time. If we did, there would be no reason to buy the protection the put offers. There are a number of reasons why someone might want the protection -- if they were concerned about a possible market decline, if they were too stressed about their investments and wanted to remove some risk (they could also just sell some shares if this were the case), if they were deliberately constructing a portfolio with certain risk-reward characteristics and buying puts on some positions allowed them to do so, and so on. 

The first reason seems interested in how likely the put is to be profitable, but it's just a feeling someone has. While investment professionals may have models that help them predict this, most of us don't. A feeling isn't predicting the future. It's just an emotional response to possible future outcomes. So really, all of these reasons consider a possible future where we don't know how likely the stock is to go down. The purpose of the protective put is not only to potentially save you money, but also take away the chance of losing money and reduce the stress you might feel from not knowing if the stock might crash.

Here's something to think about: which of these two scenarios is the protective put to be more successful? The first is when the stock goes up by \$20 and the put expires worthless, so we bought protection but didn't need it. The second is when the stock falls by \$50 (from \$200 to \$150), and the put makes it so that we lose \$36 instead of \$50. It's \$36 because we paid \$16 to buy the put, and we lose another \$20 before the protection of the \$180 strike put kicks in. Is the protective put successful when the stock declines and we end up needing the protection, or when the stock goes up and we removed the risk at the cost of making slightly less money? 


## Covered Call

A covered call combines owning shares of a stock with selling calls on the same stock. The goal of this strategy is *yield enhancement*: repeatedly selling calls against a stock we already own gives us extra cash every month. This payoff diagram has two dotted lines -- buying shares at \$200 and selling a call at \$8/share. The solid line, the covered call, combines the two dotted lines.

```{r XYZ-Covered-Call, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 8; Call_K <- 220
Stock_cost <- 200
x_min <- 120; x_max = 280

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Call_Payoff_XYZ_220 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -( -Call_cost + (Call_x > Call_K)*(Call_x-Call_K) ),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) <= 0,
                                                    "Profit_call", "Loss_call") )

Covered_Call_Payoff_XYZ <- tibble( "Covered_Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Covered_Call_y" = -(-Call_cost + (Covered_Call_x > Call_K)*(Covered_Call_x-Call_K)) + 
                                                  seq(from = x_min, to = x_max, by = 0.01) - Stock_cost,
                            "Profitable" = ifelse( -( -Call_cost + (Covered_Call_x > Call_K)*(Covered_Call_x-Call_K) ) + 
                                                  seq(from = x_min, to = x_max, by = 0.01) - Stock_cost > 0, 
                                                  "Profit_covered_call","Loss_covered_call") )


sl1 <- bracketsGrob(0.25, 0.30, 0.25, 0.50, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.655, 0.725, 0.50, lwd=2, col="green3")

annotate_arrow_1 <- data.frame(x1 = 167.5, x2 = 155, y1 = 20, y2 = 15)
annotate_arrow_2 <- data.frame(x1 = 222.5, x2 = 235, y1 = 51, y2 = 45)

temp <- covered_call_payoff(data_covered_call = Covered_Call_Payoff_XYZ,
                            data_stock = Stock_Payoff_XYZ, data_call = Call_Payoff_XYZ_220,
                            main_title = "Covered Call",
                            sub_title = "")
                            # sub_title = "Buy 100 shares at $200/share\nSell 1 call for $8/share at the $220 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) +
     # annotate( geom = "text", x = 125, y = -15, color = "red", hjust = 0,
     #           label = paste0("Losses"), size = 5 ) +
     # annotate( geom = "text", x = 255, y = 10, color = "green3", hjust = 0,
     #           label = paste0("Profits"), size = 5 ) +
     annotate( geom = "text", x = Stock_cost - Call_cost - 15,
               y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost - Call_cost)), size = 4 ) +
     annotate( geom = "text", x = Stock_cost - Call_cost - 15,
               y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +
     # annotation_custom( sl1 ) + annotation_custom( sl2 ) + 
     annotate( geom = "text", x = 169, y = 19, color = "gray50", hjust = 0, 
               label = paste0("Call"), size = 4 ) +
     annotate( geom = "text", x = 215, y = 59, color = "gray50", hjust = 0, 
               label = paste0("Shares"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate( geom = "text", x = 228-4, y = -9, color = "gray50", hjust = 0,
                  label = paste0("$228"), size = 3.5 ) +
     annotate("point", x = 220+8, y = 0, colour = "gray50") + 
     annotate( geom = "text", x = 196, y = -9, color = "gray50", hjust = 0,
                  label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 200, y = 0, colour = "gray50") 

temp; rm(temp)
```
Since we'll be buying and selling options, depending on the strategy we consider, we need an easy way to refer to if we bought or sold it. We say we're long if we buy something, and say we're short if we sold something. When we buy a call, we might say we're long a call or have a long call. When we buy a put, we might say we're long a put or have a long put. But remember, puts make money when their stock goes down. So saying we're long a put doesn't mean we make money when the stock goes up. It means we bought the put. 

Just like last time, we'll break up the payoff diagram into two sections: above and below the strike price of the option. We sold the call at the \$220 strike, so we have a short call position with a \$220 strike. Before \$220, we make the \$8 we get from selling the call. That makes the covered call, which combines owning shares at \$200 with selling the call, \$8 more profitable than just owning the shares. The diagram shows the covered call shifted upwards, compared to owning the shares. 

We're also long the shares, After \$220, the call loses a dollar for dollar what the shares make, and the covered call captures this by flattening out. It's still profitable by the \$8 we received for selling the call, but 

<!-- 
## Sythentic Long Stock

Say we want to replicate the payoff diagram of owning Company XYZ's using calls and puts. 

```{r XYZ-Stock-Demo, fig.align = "center", out.width = out_width_plot, message = FALSE}
Stock_cost <- 200
x_min = 160; x_max = 240

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit","Loss") )

s1 <- bracketsGrob(0.25, 0.25, 0.25, 0.5, lwd=2, col="red")
s2 <- bracketsGrob(0.75, 0.75, 0.75, 0.5, lwd=2, col="green3")

### Source: https://stackoverflow.com/questions/35633239/add-curly-braces-to-ggplot2-and-then-use-ggsave
temp <- stock_payoff(Stock_Payoff_XYZ, main = "Buy XYZ's shares at $200/share.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( y_axis_labels < 0, "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
     annotate( geom = "text", x = 160, y = -12, color = "red", hjust = 0, 
               label = paste0("Losses"), size = 5 ) + 
     annotate( geom = "text", x = 231, y = 12, color = "green3", hjust = 0, 
               label = paste0("Profits"), size = 5 ) + 
     annotate( geom = "text", x = Stock_cost-7.5, y = min(y_axis_labels), color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost)), size = 4 ) + 
     annotate( geom = "text", x = Stock_cost-7.5, y = min(y_axis_labels), color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +
     annotation_custom( s1 ) + annotation_custom( s2 ) 

temp; rm(temp)
```

This is the payoff diagram for owning Company XYZ's stock that we saw in Chapter 2. I want the *same* payoff diagram using calls and puts. The key is to remember that a call makes money when the stock goes up, and a put makes money when the stock goes down. The easiest way to do this is to look at the different *parts* of the payoff diagram. This one has two parts, on one each side of the breakeven price of \$200. To the right of the breakeven, we *make* money when the stock goes up. That sounds like a call, so I'm going to buy a \$200 strike call to replicate the green part of the payoff diagram. To the left of \$200, we lose money as the stock goes down. If I buy a put, I make money as the stock goes down, but I want the opposite of that. So I'm going to sell a \$200 strike put to replicate the red part of payoff diagram. 

My first attempt at replicating the payoff diagram of owning one share of Company XYZ is to buy a \$200 strike call for \$15 (per share) and sell a \$200 strike put for \$20 (per share), where the call and the put have the same expiry date.  

```{r XYZ-Synthetic-Long, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 15; Put_cost <- 20
Call_K <- 200; Put_K <- 200
Stock_cost <- 200
x_min <- 120; x_max = 280

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Call_Payoff_XYZ_200 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ_200 <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                              "Put_y" = -( -Put_cost - (Put_x < Put_K) * (Put_x - Put_K) ),
                              "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) < 0,
                                                    "Profit_put", "Loss_put") )

Sythetic_Long_Payoff_XYZ <- tibble( "Synthetic_Long_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Synthetic_Long_y" = ( -Call_cost + (Synthetic_Long_x > Call_K)*(Synthetic_Long_x-Call_K) ) 
                            - ( -Put_cost - (Synthetic_Long_x < Put_K) * (Synthetic_Long_x - Put_K) ),
                            "Profitable" = ifelse( ( -Call_cost + (Synthetic_Long_x > Call_K)*(Synthetic_Long_x-Call_K) ) 
                            - ( -Put_cost - (Synthetic_Long_x < Put_K) * (Synthetic_Long_x - Put_K) ) > 0, 
                                                  "Profit_stock","Loss_stock") )


sl1 <- bracketsGrob(0.25, 0.25, 0.25, 0.465, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.725, 0.725, 0.465, lwd=2, col="green3")

temp <- synthetic_long_payoff(data_synthetic_long = Sythetic_Long_Payoff_XYZ,
                    data_call = Call_Payoff_XYZ_200, data_put = Put_Payoff_XYZ_200,
                    main_title = "A Sythentic Long Position",
                    sub_title = "Buy 1 XYZ call for $15/share at the $200 strike\nSell 1 XYZ put for $20/share at the $200 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
     annotate( geom = "text", x = 125, y = -20, color = "red", hjust = 0, 
               label = paste0("Losses"), size = 5 ) + 
     annotate( geom = "text", x = 255, y = 21, color = "green3", hjust = 0, 
               label = paste0("Profits"), size = 5 ) + 
     annotate( geom = "text", x = Call_K+Call_cost-33, y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost-Put_cost)), size = 4 ) + 
     annotate( geom = "text", x = Call_K+Call_cost-33, y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +  
     annotation_custom( sl1 ) + annotation_custom( sl2 ) 

temp; rm(temp)
```
In this picture, the \$200 strike *long call* and \$200 strike *short put* are the two dashed lines, and the replicated *long stock* position is the solid line. Putting "long" or "short" before a position is just a shorthand way of saying if we bought it (are "long" it) or sold it (are "short" it). We bought the \$200 strike call, so it is a *long call*. We sold the \$200 strike put, so it is a *short put*. We are replicating the payoff of owning a stock, so it is a *long stock* position. This is a very useful shorthand, and one that I'll be using throughout the rest of the book.

How do we get the solid line from the two dashed lines? The \$200 strike call starts off flat and 

It might take a minute or two of staring at the plot, but you should be able to convince yourself of this

Jumping back into the picture, the breakeven is \$195. That's because we bought a \$200 strike call for \$15, and sold a \$200 strike for \$20. Let's ignore the cost of the two options for a moment, and suppose that XYZ's shares are exactly at \$200 on the expiry date. The 

--> 

## Straddle

```{r XYZ-Straddle, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                    "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                    - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                    "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                           - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                           "Profit_right_straddle","Loss_right_straddle") )  

annotate_arrow_1 <- data.frame(x1 = 180, x2 = 170, y1 = 25, y2 = 20)
annotate_arrow_2 <- data.frame(x1 = 235, x2 = 245, y1 = 45, y2 = 40)

temp <- straddle_payoff( data_straddle_left = Straddle_Payoff_XYZ_left,
                         data_straddle_center = Straddle_Payoff_XYZ_center,
                         data_straddle_right = Straddle_Payoff_XYZ_right,
                         data_call = Call_Payoff_XYZ, 
                         data_put = Put_Payoff_XYZ,
                         main_title = "Straddle",
                         sub_title = "" )
                         # sub_title = "Buy 1 XYZ call for $10/share at the $200 strike.\nBuy 1 XYZ put for $15/share at the $200 strike.")

y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
     annotate( geom = "text", x = 182.5, y = 25, color = "gray50", hjust = 0, 
               label = paste0("Put"), size = 4 ) +
     annotate( geom = "text", x = 230, y = 49, color = "gray50", hjust = 0, 
               label = paste0("Call"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate( geom = "text", x = 196, y = -19, color = "gray50", hjust = 0,
               label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 200, y = -15, colour = "gray50") + 
     annotate( geom = "text", x = 194, y = -5, color = "gray50", hjust = 0,
               label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 200, y = -10, colour = "gray50") 

temp; rm(temp)
```

```{r XYZ-Straddle-Normal, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                    "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                    - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                    "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                           - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                           "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_Normal <- tibble( "Dist_x" = seq(from = x_min, to = x_max, by = 0.01), 
                                  "Dist_y" = 10 * 1000 * (55/200) * dnorm(Dist_x, mean = 200, sd = 20) )


temp <- straddle_payoff_dist_overlay( data_straddle_left = Straddle_Payoff_XYZ_left,
                                      data_straddle_center = Straddle_Payoff_XYZ_center,
                                      data_straddle_right = Straddle_Payoff_XYZ_right,
                                      data_distribution_overlay = Straddle_Payoff_Normal, 
                                      fill_rgb = col2rgb("cornflowerblue"),
                                      main_title = "Straddle",
                                      sub_title = "One trader's view of probable future market prices.",
                                      curve_text = "We capture \nthe trader's view \nof the unknown \nfuture price with \ncurves like this one.",
                                      curve_text_x = 200, 
                                      curve_text_y = 30 )

y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) )
temp; rm(temp)
```

```{r XYZ-Straddle-Lognormal-Over-K, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                    "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                    - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                    "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                           - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                           "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_Lognormal <- tibble( "Dist_x" = seq(from = x_min, to = x_max, by = 0.01), 
                                     "Dist_y" = 10 * 1000 * (45/200) * dlnorm(Dist_x, meanlog = log(225), sdlog = log(1.075)) )

temp <- straddle_payoff_dist_overlay( data_straddle_left = Straddle_Payoff_XYZ_left,
                                      data_straddle_center = Straddle_Payoff_XYZ_center,
                                      data_straddle_right = Straddle_Payoff_XYZ_right,
                                      data_distribution_overlay = Straddle_Payoff_Lognormal, 
                                      fill_rgb = col2rgb("cornflowerblue"),
                                      main_title = "Straddle",
                                      sub_title = "Another trader's view of probable future market prices.",
                                      curve_text = "He thinks the \nstock is much \nmore likely to \nbe over $200.",
                                      curve_text_x = 225, 
                                      curve_text_y = 30 )
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) )
temp; rm(temp)
```


```{r XYZ-Straddle-Multimodal, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_Multimodal <- tibble( "Dist_x" = seq(from = x_min, to = x_max, by = 0.01), 
                                      "Dist_y" = 2.5 * 1000 * dnorMix( x = Dist_x, 
                                                          obj = norMix(mu = c(175, 220), sigma = c(10,17.5), w = c(0.4,0.6)) ) )

temp <- straddle_payoff_dist_overlay( data_straddle_left = Straddle_Payoff_XYZ_left,
                                      data_straddle_center = Straddle_Payoff_XYZ_center,
                                      data_straddle_right = Straddle_Payoff_XYZ_right,
                                      data_distribution_overlay = Straddle_Payoff_Multimodal, 
                                      fill_rgb = col2rgb("cornflowerblue"),
                                      main_title = "Straddle",
                                      sub_title = "A third trader's view of probable future market prices.",
                                      curve_text = "She thinks \nit is likely more \nthan $200 or less \nthan $200.",
                                      curve_text_x = 220.5, 
                                      curve_text_y = 17 )
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) )
temp; rm(temp)
```

## Collar 

In the covered call, we bought 100 shares and sold 1 call. In the protective put, we bought 100 shares and bought 1 put. In the collar, we *combine* these two strategies: we buy 100 shares, buy 1 put, and sell 1 call. The idea here is that we want the protection offered by the put, but we want to offset the cost of the put so we sell a call too. 

```{r XYZ-Collar-Left, fig.align = "center", out.width = out_width_plot, message = FALSE}
Put_cost <- 16; Put_K <- 180
Call_cost <- 8; Call_K <- 220
Stock_cost <- 200
x_min <- 120; x_max = 260


Stock_Payoff_XYZ <- tibble( "Stock_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Stock_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Call_Payoff_XYZ_220 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -( -Call_cost + (Call_x > Call_K)*(Call_x-Call_K) ),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) < 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ_180 <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                              "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                              "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) > 0,
                                                    "Profit_put", "Loss_put") )

Collar_Payoff_XYZ <- tibble( "Collar_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Collar_y" = -(-Call_cost + (Collar_x > Call_K)*(Collar_x-Call_K) ) 
                            + ( -Put_cost - (Collar_x < Put_K) * (Collar_x - Put_K) ) + Collar_x - Stock_cost,
                            "Profitable" = ifelse( Collar_y > 0, "Profit_collar","Loss_collar") ) 

sl1 <- bracketsGrob(0.25, 0.345, 0.25, 0.51, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.565, 0.725, 0.49, lwd=2, col="green3")

# fill_color_left <- data.frame(xstart = 120, xend = 200, col = "aliceblue")
# fill_color_right <- data.frame(xstart = 200, xend = 280, col = "aliceblue")

fill_color_right <- data.frame(xstart = 120, xend = 180, col = "white")
fill_color_left <- data.frame(xstart = 180, xend = 260, col = "white")

annotate_arrow_1 <- data.frame(x1 = 155, x2 = 145, y1 = 30, y2 = 25)
annotate_arrow_2 <- data.frame(x1 = 130, x2 = 140, y1 = -5, y2 = 2.5)
annotate_arrow_3 <- data.frame(x1 = 167.5, x2 = 160, y1 = -55, y2 = -47.5)

temp <- collar_payoff_left(data_collar = Collar_Payoff_XYZ, data_stock = Stock_Payoff_XYZ,
                      data_call = Call_Payoff_XYZ_220, data_put = Put_Payoff_XYZ_180,
                      main_title = "Collar", 
                      sub_title = "")
                      # sub_title = "Buy 100 shares of at $200/share.\nSell 1 call for $8/share at the $220 strike.\nBuy 1 put for $16/share at the $180 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) +
     # annotate( geom = "text", x = 125, y = -11, color = "red", hjust = 0,
     #           label = paste0("Losses"), size = 5 ) +
     # annotate( geom = "text", x = 255, y = 5, color = "green3", hjust = 0,
     #           label = paste0("Profits"), size = 5 ) +
     annotate( geom = "text", x = Call_K+Call_cost-35, y = min(y_axis_labels), color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost-Call_cost+Put_cost)), size = 4 ) +
     annotate( geom = "text", x = Call_K+Call_cost-35, y = min(y_axis_labels), color = "red", hjust = 0,
               label = "Breakev", size = 4 ) + 
     # annotation_custom( sl1 ) + annotation_custom( sl2 )
     annotate( geom = "text", x = 157.5, y = 30, color = "gray50", hjust = 0, 
               label = paste0("Put"), size = 4 ) +
     annotate( geom = "text", x = 160, y = -60, color = "gray50", hjust = 0, 
               label = paste0("Shares"), size = 4 ) + 
     annotate( geom = "text", x = 120, y = -7, color = "gray50", hjust = 0, 
               label = paste0("Call"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate("point", x = 180-16, y = 0, colour = "gray50") + 
     annotate( geom = "text", x = 180-16-4, y = -7.5, color = "gray50", hjust = 0,
               label = paste0("$164"), size = 3.5 ) +
     annotate("point", x = 200, y = 0, colour = "gray50") +
     annotate( geom = "text", x = 200-9, y = 3, color = "gray50", hjust = 0,
               label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 228, y = 0, colour = "gray65") + 
     annotate( geom = "text", x = 228-5, y = -7.5, color = "gray65", hjust = 0,
               label = paste0("$228"), size = 3.5 ) 
     

temp; rm(temp)
```

```{r XYZ-Collar-Right, fig.align = "center", out.width = out_width_plot, message = FALSE}
Put_cost <- 16; Put_K <- 180
Call_cost <- 8; Call_K <- 220
Stock_cost <- 200
x_min <- 120; x_max = 260


Stock_Payoff_XYZ <- tibble( "Stock_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Stock_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Call_Payoff_XYZ_220 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -( -Call_cost + (Call_x > Call_K)*(Call_x-Call_K) ),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) < 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ_180 <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                              "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                              "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) > 0,
                                                    "Profit_put", "Loss_put") )

Collar_Payoff_XYZ <- tibble( "Collar_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Collar_y" = -(-Call_cost + (Collar_x > Call_K)*(Collar_x-Call_K) ) 
                            + ( -Put_cost - (Collar_x < Put_K) * (Collar_x - Put_K) ) + Collar_x - Stock_cost,
                            "Profitable" = ifelse( Collar_y > 0, "Profit_collar","Loss_collar") ) 

# fill_color_left <- data.frame(xstart = 120, xend = 200, col = "aliceblue")
# fill_color_right <- data.frame(xstart = 200, xend = 280, col = "aliceblue")

fill_color_right <- data.frame(xstart = 120, xend = 180, col = "white")
fill_color_left <- data.frame(xstart = 180, xend = 260, col = "white")

annotate_arrow_1 <- data.frame(x1 = 215, x2 = 225, y1 = 40, y2 = 35)
annotate_arrow_2 <- data.frame(x1 = 210, x2 = 220, y1 = -27.5, y2 = -20)
annotate_arrow_3 <- data.frame(x1 = 247.5, x2 = 240, y1 = 0, y2 = -7.5)

sl1 <- bracketsGrob(0.25, 0.345, 0.25, 0.51, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.55, 0.725, 0.49, lwd=2, col="green3")

temp <- collar_payoff_right(data_collar = Collar_Payoff_XYZ, data_stock = Stock_Payoff_XYZ,
                      data_call = Call_Payoff_XYZ_220, data_put = Put_Payoff_XYZ_180,
                      main_title = "Collar", 
                      sub_title = "")
                      # sub_title = "Buy 100 shares at $200/share.\nSell 1 call for $8/share at the $220 strike.\nBuy 1 put for $16/share at the $180 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) +
     # annotate( geom = "text", x = 125, y = -11, color = "red", hjust = 0,
     #           label = paste0("Losses"), size = 5 ) +
     # annotate( geom = "text", x = 255, y = 5, color = "green3", hjust = 0,
     #           label = paste0("Profits"), size = 5 ) +
     annotate( geom = "text", x = Call_K+Call_cost-35, y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost-Call_cost+Put_cost)), size = 4 ) +
     annotate( geom = "text", x = Call_K+Call_cost-35, y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) + 
     # annotation_custom( sl1 ) + annotation_custom( sl2 )
     annotate( geom = "text", x = 202.5, y = -27.5, color = "gray50", hjust = 0, 
               label = paste0("Put"), size = 4 ) +
     annotate( geom = "text", x = 205, y = 47.5, color = "gray50", hjust = 0, 
               label = paste0("Shares"), size = 4 ) + 
     annotate( geom = "text", x = 249, y = 0, color = "gray50", hjust = 0, 
               label = paste0("Call"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate("point", x = 180-16, y = 0, colour = "gray65") + 
     annotate( geom = "text", x = 180-16-4, y = -7.5, color = "gray65", hjust = 0,
               label = paste0("$164"), size = 3.5 ) +
     annotate("point", x = 200, y = 0, colour = "gray65") +
     annotate( geom = "text", x = 200-9, y = 3, color = "gray65", hjust = 0,
               label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 228, y = 0, colour = "gray50") + 
     annotate( geom = "text", x = 228-5, y = -7.5, color = "gray50", hjust = 0,
               label = paste0("$228"), size = 3.5 ) 
     

temp; rm(temp)
```