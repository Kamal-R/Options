<!-- Each chapter is set to compile separately - include "global" set-up -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

CRAN_repo = getOption("repos")
CRAN_repo["CRAN"] = "http://cran.us.r-project.org"
options(repos = CRAN_repo)

if ( !require("here") )          { install.packages("here") };            require(here)
if ( !require("tidyverse") )     { install.packages("tidyverse") };       require(tidyverse)
if ( !require("ggtext") )        { install.packages("ggtext") };          require(ggtext)
if ( !require("pBrackets") )     { install.packages("pBrackets") };       require(pBrackets)
if ( !require("htmlwidgets") )   { install.packages("htmlwidgets") };     require(htmlwidgets)
if ( !require("plotly") )        { install.packages("plotly") };          require(plotly)
if ( !require("formattable") )   { install.packages("formattable") };     require(formattable)
if ( !require("kableExtra") )    { install.packages("kableExtra") };      require(kableExtra)
if ( !require("rtsdata") )       { install.packages("rtsdata") };         require(rtsdata)
if ( !require("PerformanceAnalytics") )     { install.packages("PerformanceAnalytics") };   require(PerformanceAnalytics)
if ( !require("anytime") )       { install.packages("anytime") };         require(anytime)
if ( !require("nor1mix") )       { install.packages("nor1mix") };         require(nor1mix)

options(kableExtra.html.bsTable = TRUE)
options(kableExtra.auto_format = FALSE)

out_width_plot <- "97.5%"
out_width_table <- "97.5%"
grid::grid.locator(unit="npc") 

plot_bg <- "#FFFFFF"
plot_fg <- "#000000" 
plot_fg_alt <- "#969696" 

source("Plotting_Functions.R")
```

```{r Table-Helper-Functions}
at_least_number <- function(x,number) {
  ifelse( typeof(x) == "character", 
          return( as.numeric(gsub('\\(','-',gsub('[)$,]', '', x))) >= number ),
          return( x >= number) )
}

remove_negative_zeros <- function(x) { (x[which(-1e-4 < x & x < 1e-4)] = 0); return(x) }
```

# Building Options Strategies

We can do a lot more with options than just buying or selling one put or one call. Stocks, calls, and puts are the basic building blocks that we can combine to construct investments with any payoff structure we want. There are tons of options strategies, and they're all just combinations of these building blocks. You don't need to know their names to understand their strengths and weaknesses, and the goal of this chapter is to show you how to construct options strategies on-the-fly that have the payoff that you want. In the next few chapters, we'll talk about the greeks, which will let us understand how options change price before their expiry date. They're the tool we need before we can consider payoff diagrams before expiry dates. For now, let's nail down how to construct payoff diagrams for strategies on expiry dates. 

## Protective Put

A protective put combines owning shares of a stock with buying puts on the same stock. The goal of this strategy is protect the stock position against potentially large losses. The payoff diagram has two dotted lines. The first shows buying a put at the \$180 strike for \$16/share. The second shows buying 1 share at \$200. The solid line, the protective put, combines the two dotted lines.

```{r XYZ-Protective-Put, fig.align = "center", out.width = out_width_plot, message = FALSE}
Put_cost <- 16; Put_K <- 180
Stock_cost <- 200
x_min <- 120; x_max = 280

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Put_Payoff_XYZ_180 <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                              "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                              "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                    "Profit_put", "Loss_put") )

Protective_Put_Payoff_XYZ <- tibble( "Protective_Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Protective_Put_y" = -Put_cost - (Protective_Put_x < Put_K) * (Protective_Put_x - Put_K) + 
                                                  seq(from = x_min, to = x_max, by = 0.01) - Stock_cost,
                            "Profitable" = ifelse( ( -Put_cost - (Protective_Put_x < Put_K) * (Protective_Put_x - Put_K) + 
                                                  seq(from = x_min, to = x_max, by = 0.01) - Stock_cost) > 0, 
                                                  "Profit_protective_put","Loss_protective_put") )


sl1 <- bracketsGrob(0.25, 0.30, 0.25, 0.50, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.625, 0.725, 0.50, lwd=2, col="green3")

annotate_arrow_1 <- data.frame(x1 = 150, x2 = 140, y1 = 35, y2 = 30)
annotate_arrow_2 <- data.frame(x1 = 225, x2 = 235, y1 = 50, y2 = 45)

temp <- protective_put_payoff(data_protective_put = Protective_Put_Payoff_XYZ,
                              data_stock = Stock_Payoff_XYZ, data_put = Put_Payoff_XYZ_180,
                              main_title = "Protective Put",
                              sub_title = "" )
                              # sub_title = "Buy 100 shares at $200/share\nBuy 1 put for $16/share at the $180 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) +
     # annotate( geom = "text", x = 125, y = -15, color = "red", hjust = 0,
     #           label = paste0("Losses"), size = 5 ) +
     # annotate( geom = "text", x = 255, y = 10, color = "green3", hjust = 0,
     #           label = paste0("Profits"), size = 5 ) +
     annotate( geom = "text", x = Put_cost + Stock_cost - 15, 
               y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Put_cost + Stock_cost)), size = 4 ) +
     annotate( geom = "text", x = Put_cost + Stock_cost - 15, 
               y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +
     # annotation_custom( sl1 ) + annotation_custom( sl2 ) + 
     annotate( geom = "text", x = 152.5, y = 35, color = "gray50", hjust = 0, 
               label = paste0("Put"), size = 4 ) +
     annotate( geom = "text", x = 215, y = 59, color = "gray50", hjust = 0, 
               label = paste0("Shares"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate( geom = "text", x = 175-16, y = 7.5, color = "gray50", hjust = 0,
                  label = paste0("$164"), size = 3.5 ) +
     annotate("point", x = 180-16, y = 0, colour = "gray50") + 
     annotate( geom = "text", x = 195, y = 7.5, color = "gray50", hjust = 0,
                  label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 200, y = 0, colour = "gray50") 

temp; rm(temp)
```
Let's look at the \$180 strike put first. It goes up dollar-for-dollar as the stock falls below \$180. The stock (always) goes up dollar-for-dollar, so below \$180 the put and stock cancel each other out. The protective put captures this, as it is flat below \$180. Above \$180, the put's payoff does not change while the stock goes up dollar-for-dollar. The protective put goes up dollar-for-dollar above \$180, but is parallel to the stock because the put cost \$16/share. This makes the payoff of the protective payoff \$16 less than the stock. This is also reflected in its higher breakeven of \$216 = \$200 + \$16.

The takeaway is that we can use a put to "cancel out" losses from buying shares that are below the strike price of the put (on the expiry date of the put). Also, breaking up the payoff diagram based on the behavior of the options we're considering is a fundamental strategy that we'll be repeating every time we encounter a new options strategy. It will be more familiar over time, and let you construct trades with your desired payoff structure relatively easily. 

A cautionary note: the payoff diagram doesn't capture how likely these two outcomes are. They're uncertain future outcomes and we don't know which one will happen ahead of time. If we did, there would be no reason to buy the protection the put offers. There are a number of reasons why someone might want the protection -- if they were concerned about a possible market decline, if they were too stressed about their investments and wanted to remove some risk (they could also just sell some shares if this were the case), if they were deliberately constructing a portfolio with certain risk-reward characteristics and buying puts on some positions allowed them to do so, and so on. 

The first reason seems interested in how likely the put is to be profitable, but it's just a feeling someone has. While investment professionals may have models that help them predict this, most of us don't. A feeling isn't predicting the future. It's just an emotional response to possible future outcomes. So really, all of these reasons consider a possible future where we don't know how likely the stock is to go down. The purpose of the protective put is not only to potentially save you money, but also take away the chance of losing money and reduce the stress you might feel from not knowing if the stock might crash.

Here's something to think about: which of these two scenarios is the protective put to be more successful? The first is when the stock goes up by \$20 and the put expires worthless, so we bought protection but didn't need it. The second is when the stock falls by \$50 (from \$200 to \$150), and the put makes it so that we lose \$36 instead of \$50. It's \$36 because we paid \$16 to buy the put, and we lose another \$20 before the protection of the \$180 strike put kicks in. Is the protective put successful when the stock declines and we end up needing the protection, or when the stock goes up and we removed the risk at the cost of making slightly less money? 


## Covered Call

A covered call combines owning shares of a stock with selling calls on the same stock. The goal of this strategy is *yield enhancement*: repeatedly selling calls against a stock we already own gives us extra cash every month. This payoff diagram has two dotted lines -- buying shares at \$200 and selling a call at \$8/share. The solid line, the covered call, combines the two dotted lines.

Since we'll be buying and selling options in these strategies, we need an easy way to refer to if we bought or sold them. We say we're long if we buy something, and short if we sell something. When we buy a call, we say we're long a call or have a long call. When we buy a put, we say we're long a put or have a long put. But remember, puts make money when their stock goes down. So saying we're long a put doesn't mean we make money when the stock goes up. It means we bought the put. 

```{r XYZ-Covered-Call, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 8; Call_K <- 220
Stock_cost <- 200
x_min <- 120; x_max = 280

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Call_Payoff_XYZ_220 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -( -Call_cost + (Call_x > Call_K)*(Call_x-Call_K) ),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) <= 0,
                                                    "Profit_call", "Loss_call") )

Covered_Call_Payoff_XYZ <- tibble( "Covered_Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Covered_Call_y" = -(-Call_cost + (Covered_Call_x > Call_K)*(Covered_Call_x-Call_K)) + 
                                                  seq(from = x_min, to = x_max, by = 0.01) - Stock_cost,
                            "Profitable" = ifelse( -( -Call_cost + (Covered_Call_x > Call_K)*(Covered_Call_x-Call_K) ) + 
                                                  seq(from = x_min, to = x_max, by = 0.01) - Stock_cost > 0, 
                                                  "Profit_covered_call","Loss_covered_call") )


sl1 <- bracketsGrob(0.25, 0.30, 0.25, 0.50, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.655, 0.725, 0.50, lwd=2, col="green3")

annotate_arrow_1 <- data.frame(x1 = 167.5, x2 = 155, y1 = 20, y2 = 15)
annotate_arrow_2 <- data.frame(x1 = 222.5, x2 = 235, y1 = 51, y2 = 45)

temp <- covered_call_payoff(data_covered_call = Covered_Call_Payoff_XYZ,
                            data_stock = Stock_Payoff_XYZ, data_call = Call_Payoff_XYZ_220,
                            main_title = "Covered Call",
                            sub_title = "")
                            # sub_title = "Buy 100 shares at $200/share\nSell 1 call for $8/share at the $220 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) +
     # annotate( geom = "text", x = 125, y = -15, color = "red", hjust = 0,
     #           label = paste0("Losses"), size = 5 ) +
     # annotate( geom = "text", x = 255, y = 10, color = "green3", hjust = 0,
     #           label = paste0("Profits"), size = 5 ) +
     annotate( geom = "text", x = Stock_cost - Call_cost - 15,
               y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost - Call_cost)), size = 4 ) +
     annotate( geom = "text", x = Stock_cost - Call_cost - 15,
               y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +
     # annotation_custom( sl1 ) + annotation_custom( sl2 ) + 
     annotate( geom = "text", x = 169, y = 19, color = "gray50", hjust = 0, 
               label = paste0("Call"), size = 4 ) +
     annotate( geom = "text", x = 215, y = 59, color = "gray50", hjust = 0, 
               label = paste0("Shares"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate( geom = "text", x = 228-4, y = -9, color = "gray50", hjust = 0,
                  label = paste0("$228"), size = 3.5 ) +
     annotate("point", x = 220+8, y = 0, colour = "gray50") + 
     annotate( geom = "text", x = 196, y = -9, color = "gray50", hjust = 0,
                  label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 200, y = 0, colour = "gray50") 

temp; rm(temp)
```
Just like last time, we'll break up the payoff diagram into two sections: above and below the strike price of the option. We sold the call, so we have a short call at a \$220 strike. Before \$220, we make \$8/share from selling the call. That makes the covered call, which combines owning shares at \$200 with selling this call, \$8/share more profitable than just owning shares. The payoff diagram shows the covered call shifted upwards, compared to just owning the shares. After \$220, the call loses a dollar-for-dollar what the shares make, and so the covered call flattens out. We bought the shares at \$200 and sold the call at the \$220 strike, so we make \$20/share from owning the shares before the short call kicks in. We still make \$8/share for selling the call, for a maximum gain of \$28/share. The cost of collecting \$8/share in income is that we "canceled out" all potential gains from the shares going above \$220. 

If we open a covered call, we probably don't want to sell the shares and keep the call. The risk is that the stock goes through the roof, to say \$250. The person who owns the \$220 strike call will exercise it. Since we sold the call, we're obligated to deliver the shares to them. If we don't own the shares, we have to buy at \$250, and sell at \$220 to fulfill our commitment. We'll lose \$30/share, and if the stock goes higher than \$250 we'll lose even more. To avoid the potential for those kinds of large losses, we have to view the shares and short call as a package deal -- if we own one, we own the other. 

If the stock falls below \$192, the covered call loses money, but it loses less than than just owning shares. Your perspective on if this is a good outcome might depend on why you entered the trade. If you view the stock as a long-term holding, you'll likely hold through a decline, so the \$8/share of income you collect is a bonus. While you're not happy the stock is below \$192, you're probably happy the call let you recoup \$8/share of those losses. You might even consider selling another call to help recoup more of your losses. If you view the covered call as a tactical position and it loses money, you're faced with the decision of taking the loss or selling another covered call to try and recoup your losses. In this case, you probably wish you sold the covered call when the shares were above \$192.

What are the favorable outcomes for a covered call? For me, the answer comes by comparing it to just owning shares. The covered call is worse above \$228, and better below \$228. But even it loses money below \$192, which we'd like to avoid. The sweet spot for the covered call is between \$192 and \$228, where it's both profitable and more profitable than just owning shares. Most people who write covered calls use it as a *yield enhancement* strategy, where they sell calls to produce income. If the stock stays between \$192 and \$220, the call expires worthless and we keep \$8/share in income from selling the calls. Once the call expires, we can sell another call against our shares, and collect more income. 

```{r XYZ-Covered-Call-Scenario, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 8; Call_K <- 220
Stock_cost <- 200
x_min <- 120; x_max = 280

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Call_Payoff_XYZ_220 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -( -Call_cost + (Call_x > Call_K)*(Call_x-Call_K) ),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) <= 0,
                                                    "Profit_call", "Loss_call") )

Covered_Call_Payoff_XYZ <- tibble( "Covered_Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Covered_Call_y" = -(-Call_cost + (Covered_Call_x > Call_K)*(Covered_Call_x-Call_K)) + 
                                                  seq(from = x_min, to = x_max, by = 0.01) - Stock_cost,
                            "Profitable" = ifelse( -( -Call_cost + (Covered_Call_x > Call_K)*(Covered_Call_x-Call_K) ) + 
                                                  seq(from = x_min, to = x_max, by = 0.01) - Stock_cost > 0, 
                                                  "Profit_covered_call","Loss_covered_call") )


sl1 <- bracketsGrob(0.25, 0.30, 0.25, 0.50, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.655, 0.725, 0.50, lwd=2, col="green3")

annotate_arrow_1 <- data.frame(x1 = 167.5, x2 = 155, y1 = 20, y2 = 15)
annotate_arrow_2 <- data.frame(x1 = 222.5, x2 = 235, y1 = 51, y2 = 45)
annotate_arrow_3 <- data.frame(x1 = 207.5, x2 = 220, y1 = 37.5, y2 = 35)

temp <- covered_call_payoff(data_covered_call = Covered_Call_Payoff_XYZ,
                            data_stock = Stock_Payoff_XYZ, data_call = Call_Payoff_XYZ_220,
                            main_title = "Covered Call",
                            sub_title = "")
                            # sub_title = "Buy 100 shares at $200/share\nSell 1 call for $8/share at the $220 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) +
     # annotate( geom = "text", x = 125, y = -15, color = "red", hjust = 0,
     #           label = paste0("Losses"), size = 5 ) +
     # annotate( geom = "text", x = 255, y = 10, color = "green3", hjust = 0,
     #           label = paste0("Profits"), size = 5 ) +
     annotate( geom = "text", x = Stock_cost - Call_cost - 15,
               y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost - Call_cost)), size = 4 ) +
     annotate( geom = "text", x = Stock_cost - Call_cost - 15,
               y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +
     # annotation_custom( sl1 ) + annotation_custom( sl2 ) + 
     annotate( geom = "text", x = 169, y = 19, color = "gray50", hjust = 0, 
               label = paste0("Call"), size = 4 ) +
     annotate( geom = "text", x = 215, y = 59, color = "gray50", hjust = 0, 
               label = paste0("Shares"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate( geom = "text", x = 228-4, y = -9, color = "gray50", hjust = 0,
                  label = paste0("$228"), size = 3.5 ) +
     annotate("point", x = 220+8, y = 0, colour = "gray50") + 
     annotate( geom = "text", x = 196, y = -9, color = "gray50", hjust = 0,
                  label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 200, y = 0, colour = "gray50") + 
     annotate( "path", color = "cornflowerblue",
               x = 224 + 4 * cos( seq(0,2*pi,length.out=100) ),
               y = 28 + 4 * sin( seq(0,2*pi,length.out=100) ) ) + 
    geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                arrow = arrow(length = unit(0.03, "npc")), color = "cornflowerblue",
                curvature = -0.5 ) + 
     annotate( geom = "text", x = 169.5, y = 37.5, color = "cornflowerblue", hjust = 0,
               label = paste0("One more scenario"), size = 3.75 )

temp; rm(temp)
```
There's one more scenario -- the shares are between \$220 and \$228 on the expiry date. The call has a strike price of \$220, so it will get exercised and we're obligated to deliver our shares. The short call removed all upside from owning the shares above \$220, but we make \$20/share as they rise from \$200 to \$220 and \$8/share from selling the call. Since we bought the shares at \$200 and they're under \$228 when we have to deliver the shares, the covered call is still more profitable than owning shares. At this point, we have a decision to make -- we can buy back the shares for less than \$228 and possibly sell another call against them, or we can buy back the call we sold to book the profits and possibly sell another call against our shares.

Just like with the protective put, the payoff diagram for the covered call doesn't tell me how likely these different scenarios are. I have to construct the trade based on my views about the future price of the stock, which is uncertain. Because the most favorable outcomes for this covered call happen between \$192 and \$220, it is a very different trade than just owning shares. When I just own shares, I just want the shares to go up. When I own a covered call, I want the shares to mostly stay where they are. Just like the protective put, the covered call changes your opinion of what the most favorable outcome of the trade is. This is the true power of options strategies -- being able to construct payoff diagrams where your trade is profitable under different outcomes than just the stock going up. The covered call also produces some income and helps protect against potential losses while owning shares, which are appealing in their own right.

<!-- 
## Sythentic Long Stock

Say we want to replicate the payoff diagram of owning Company XYZ's using calls and puts. 

```{r XYZ-Stock-Demo, fig.align = "center", out.width = out_width_plot, message = FALSE}
Stock_cost <- 200
x_min = 160; x_max = 240

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit","Loss") )

s1 <- bracketsGrob(0.25, 0.25, 0.25, 0.5, lwd=2, col="red")
s2 <- bracketsGrob(0.75, 0.75, 0.75, 0.5, lwd=2, col="green3")

### Source: https://stackoverflow.com/questions/35633239/add-curly-braces-to-ggplot2-and-then-use-ggsave
temp <- stock_payoff(Stock_Payoff_XYZ, main = "Buy XYZ's shares at $200/share.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( y_axis_labels < 0, "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
     annotate( geom = "text", x = 160, y = -12, color = "red", hjust = 0, 
               label = paste0("Losses"), size = 5 ) + 
     annotate( geom = "text", x = 231, y = 12, color = "green3", hjust = 0, 
               label = paste0("Profits"), size = 5 ) + 
     annotate( geom = "text", x = Stock_cost-7.5, y = min(y_axis_labels), color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost)), size = 4 ) + 
     annotate( geom = "text", x = Stock_cost-7.5, y = min(y_axis_labels), color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +
     annotation_custom( s1 ) + annotation_custom( s2 ) 

temp; rm(temp)
```

This is the payoff diagram for owning Company XYZ's stock that we saw in Chapter 2. I want the *same* payoff diagram using calls and puts. The key is to remember that a call makes money when the stock goes up, and a put makes money when the stock goes down. The easiest way to do this is to look at the different *parts* of the payoff diagram. This one has two parts, on one each side of the breakeven price of \$200. To the right of the breakeven, we *make* money when the stock goes up. That sounds like a call, so I'm going to buy a \$200 strike call to replicate the green part of the payoff diagram. To the left of \$200, we lose money as the stock goes down. If I buy a put, I make money as the stock goes down, but I want the opposite of that. So I'm going to sell a \$200 strike put to replicate the red part of payoff diagram. 

My first attempt at replicating the payoff diagram of owning one share of Company XYZ is to buy a \$200 strike call for \$15 (per share) and sell a \$200 strike put for \$20 (per share), where the call and the put have the same expiry date.  

```{r XYZ-Synthetic-Long, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 15; Put_cost <- 20
Call_K <- 200; Put_K <- 200
Stock_cost <- 200
x_min <- 120; x_max = 280

Stock_Payoff_XYZ <- tibble( "stock_price_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "stock_profit_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Call_Payoff_XYZ_200 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ_200 <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                              "Put_y" = -( -Put_cost - (Put_x < Put_K) * (Put_x - Put_K) ),
                              "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) < 0,
                                                    "Profit_put", "Loss_put") )

Sythetic_Long_Payoff_XYZ <- tibble( "Synthetic_Long_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Synthetic_Long_y" = ( -Call_cost + (Synthetic_Long_x > Call_K)*(Synthetic_Long_x-Call_K) ) 
                            - ( -Put_cost - (Synthetic_Long_x < Put_K) * (Synthetic_Long_x - Put_K) ),
                            "Profitable" = ifelse( ( -Call_cost + (Synthetic_Long_x > Call_K)*(Synthetic_Long_x-Call_K) ) 
                            - ( -Put_cost - (Synthetic_Long_x < Put_K) * (Synthetic_Long_x - Put_K) ) > 0, 
                                                  "Profit_stock","Loss_stock") )


sl1 <- bracketsGrob(0.25, 0.25, 0.25, 0.465, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.725, 0.725, 0.465, lwd=2, col="green3")

temp <- synthetic_long_payoff(data_synthetic_long = Sythetic_Long_Payoff_XYZ,
                    data_call = Call_Payoff_XYZ_200, data_put = Put_Payoff_XYZ_200,
                    main_title = "A Sythentic Long Position",
                    sub_title = "Buy 1 XYZ call for $15/share at the $200 strike\nSell 1 XYZ put for $20/share at the $200 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
     annotate( geom = "text", x = 125, y = -20, color = "red", hjust = 0, 
               label = paste0("Losses"), size = 5 ) + 
     annotate( geom = "text", x = 255, y = 21, color = "green3", hjust = 0, 
               label = paste0("Profits"), size = 5 ) + 
     annotate( geom = "text", x = Call_K+Call_cost-33, y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Call_K+Call_cost-Put_cost)), size = 4 ) + 
     annotate( geom = "text", x = Call_K+Call_cost-33, y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) +  
     annotation_custom( sl1 ) + annotation_custom( sl2 ) 

temp; rm(temp)
```
In this picture, the \$200 strike *long call* and \$200 strike *short put* are the two dashed lines, and the replicated *long stock* position is the solid line. Putting "long" or "short" before a position is just a shorthand way of saying if we bought it (are "long" it) or sold it (are "short" it). We bought the \$200 strike call, so it is a *long call*. We sold the \$200 strike put, so it is a *short put*. We are replicating the payoff of owning a stock, so it is a *long stock* position. This is a very useful shorthand, and one that I'll be using throughout the rest of the book.

How do we get the solid line from the two dashed lines? The \$200 strike call starts off flat and 

It might take a minute or two of staring at the plot, but you should be able to convince yourself of this

Jumping back into the picture, the breakeven is \$195. That's because we bought a \$200 strike call for \$15, and sold a \$200 strike for \$20. Let's ignore the cost of the two options for a moment, and suppose that XYZ's shares are exactly at \$200 on the expiry date. The 

--> 

## Straddle

The straddle combines two options positions -- a long call and a long put (with the same expiry date). Unlike the protective put and covered call, we don't own any shares in this position. The put makes money if the stock falls a lot, and the call makes money if the stock goes up a lot. The beauty of the straddle is that can be profitable regardless of the direction the stock moves, so you don't have to get the direction right to make money. The downside is that the moves have to be large enough to pay back the cost of the long call and long put, so you're hoping for a big market move in either direction. 

```{r XYZ-Straddle, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                    "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                    - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                    "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                           - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                           "Profit_right_straddle","Loss_right_straddle") )  

annotate_arrow_1 <- data.frame(x1 = 180, x2 = 170, y1 = 25, y2 = 20)
annotate_arrow_2 <- data.frame(x1 = 235, x2 = 245, y1 = 45, y2 = 40)

temp <- straddle_payoff( data_straddle_left = Straddle_Payoff_XYZ_left,
                         data_straddle_center = Straddle_Payoff_XYZ_center,
                         data_straddle_right = Straddle_Payoff_XYZ_right,
                         data_call = Call_Payoff_XYZ, 
                         data_put = Put_Payoff_XYZ,
                         main_title = "Straddle",
                         sub_title = "" )
                         # sub_title = "Buy 1 XYZ call for $10/share at the $200 strike.\nBuy 1 XYZ put for $15/share at the $200 strike.")

y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) + 
     annotate( geom = "text", x = 182.5, y = 25, color = "gray50", hjust = 0, 
               label = paste0("Put"), size = 4 ) +
     annotate( geom = "text", x = 230, y = 49, color = "gray50", hjust = 0, 
               label = paste0("Call"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate( geom = "text", x = 196, y = -19, color = "gray50", hjust = 0,
               label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 200, y = -15, colour = "gray50") + 
     annotate( geom = "text", x = 194, y = -5, color = "gray50", hjust = 0,
               label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 200, y = -10, colour = "gray50") 

temp; rm(temp)
```
Here, we can see a \$200 strike call that cost \$10/share and a \$200 strike put that cost \$15/share. To make money, the straddle has to make enough to cover the \$10/share the call cost, and the \$15/share the put cost. It can do that by moving more than \$25 in either direction -- below \$175 if it heads lower, and above \$225 if it heads higher. The protective put removes the downside risk associated with owning shares, and the covered call produces income by selling calls against shares you already own. The straddle consists of two options -- a call and a put -- and no shares. We'll get into more details about volatility when we talk about *vega* in Chapter 5, but at its heart the straddle is a long volatility trade. The optimal outcome is that the stock moves a lot, either up or down. It doesn't matter which. 

To get a better idea about how to use a straddle, we'll consider three different traders' views about likely future prices. Remember that these views are just opinions, and none of these these traders know where the shares will end up on the expiry date. These different opinions make some people buyers and some people sellers. Those people coming together gives us a market where people are willing to trade, so it's a good thing. But there's no way to know if a particular view is correct until it happens. Even worse, even if the trade is profitable, it's not obvious how to judge if the view was was successful. The next three pictures show the problem -- views describe how probable a particular price is in the future, which we can put together to tell us how likely the straddle is to be profitable on its expiry date. So even if the straddle is highly likely to be profitable, it can still be unprofitable. That means that losing money doesn't mean our views were wrong. To get an idea of how to use our views to help make profitable trades, let's look at three trader's views of what the market may do. 

```{r XYZ-Straddle-Normal, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                    "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                    - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                    "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                           - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                           "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_Normal <- tibble( "Dist_x" = seq(from = x_min, to = x_max, by = 0.01), 
                                  "Dist_y" = 10 * 1000 * (55/200) * dnorm(Dist_x, mean = 200, sd = 20) )


temp <- straddle_payoff_dist_overlay( data_straddle_left = Straddle_Payoff_XYZ_left,
                                      data_straddle_center = Straddle_Payoff_XYZ_center,
                                      data_straddle_right = Straddle_Payoff_XYZ_right,
                                      data_distribution_overlay = Straddle_Payoff_Normal, 
                                      fill_rgb = col2rgb("cornflowerblue"),
                                      main_title = "Straddle",
                                      sub_title = "One trader's view of probable future market prices.",
                                      curve_text = "We capture \nthe trader's view \nof the unknown \nfuture price with \ncurves like this one.",
                                      curve_text_x = 200, 
                                      curve_text_y = 30 )

y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) )
temp; rm(temp)
```
Our first trader (above) has a symmetric view -- he thinks the shares are equally likely to end up above \$200 or below \$200. Under his views, the straddle is unlikely to expire profitably. It seems strange for this trader to buy something that he thinks is likely to lose money, so why might he buy this straddle? The most compelling reason is as a hedge against potential stock market declines. Most of us buy stocks and we make money if they go up, but have nothing to protect us if they go down. The straddle combines upside participation (via a call) with downside protection (via a put). Provided the stock goes up *enough* before it expires, the call allows us to be profitable while still holding the put for protection. 

One major difference between a straddle and protective put is that the straddle involves buying two options that decay in value, while the protective put involves buying only one. This means we lose the entire cost of the straddle if the put and call expire worthless, while with the protective put we only lose the cost of the put. To illustrate another major difference, suppose we bought 100 shares at \$200 and a put at \$15/share. The shares cost \$200 x 100 = \$20,000 and the put costs \$15 x 100 = \$1,500, for a total cost of \$20,000 + \$1,500 = \$21,500. The call costs \$10 x 100 = \$1,000 per 100 shares and the put \$15 x 1000 = \$1,500 per 100 shares. This is a total outlay of \$2,500, which is significantly cheaper. Even though the two trades have different payoffs and risk characteristics, the straddle is a significantly cheaper way to enter a hedged position. That might be enough to entice someone to buy a straddle instead of a protective put. We'll return to the straddle and discuss more differences between it and the protective put after working our way through the greeks in the next two chapters.

```{r XYZ-Straddle-Lognormal-Over-K, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                    "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                    - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                    "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                           - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                           "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_Lognormal <- tibble( "Dist_x" = seq(from = x_min, to = x_max, by = 0.01), 
                                     "Dist_y" = 10 * 1000 * (45/200) * dlnorm(Dist_x, meanlog = log(225), sdlog = log(1.075)) )

temp <- straddle_payoff_dist_overlay( data_straddle_left = Straddle_Payoff_XYZ_left,
                                      data_straddle_center = Straddle_Payoff_XYZ_center,
                                      data_straddle_right = Straddle_Payoff_XYZ_right,
                                      data_distribution_overlay = Straddle_Payoff_Lognormal, 
                                      fill_rgb = col2rgb("cornflowerblue"),
                                      main_title = "Straddle",
                                      sub_title = "Another trader's view of probable future market prices.",
                                      curve_text = "He thinks the \nstock is much \nmore likely to \nbe over $200.",
                                      curve_text_x = 225, 
                                      curve_text_y = 30 )
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) )
temp; rm(temp)
```
Our second trader (above) does not have a symmetric view. He considers it much more likely that the stock will be above \$200 when the put and call expire, and that it is almost impossible for the put to make money. It's extremely unlikely that this trader will buy the straddle as a hedge, but what might compel him to do it? The first thing to notice is that if he's right and the stock heads higher, the straddle will make money. If he's right, he makes money. If his forecast is wrong and the stock heads lower, the straddle has a good chance of making money. If this trader has lost lots of money when he had similarly confident forecasts in the past, his experience may have taught him to diversify into strategies that perform well when the "impossible" happens. Under his views, the straddle is very likely to make money as the stock goes higher. If he's wrong and the picture above is a bad forecast, the straddle still has a good chance of making money. 

Another reason to buy the straddle is that the trader may not be confident in his forecast. If he thinks his views may be wrong, he might buy the straddle to diversify the bets he is taking. In this case, another choice is to not buy the straddle and instead search for investment opportunities where he is more confident in his forecasts. When we revisit the straddle to see how its payoff diagram behaves before its expiry date, we'll see this trader's views (if correct) will help him "defend" the straddle. We often don't want to hold an options position to expiry and run the risk of losing our entire investment. There are a truly enormous number of ways to adjust options positions to manage this risk. We'll talk about some of them later in the book. 

If it's available, one simple adjustment is to use the profits we get when the shares go higher. Suppose the shares are at \$240 and the straddle is profitable by \$10/share one month before expiry. We can sell the straddle and use the proceeds to buy another at the \$240 strike that is three months from expiry. That adjustment lets us stay in a straddle for another few more months. We can, of course, repeat this adjustment as many times as we want to stay invested in a straddle indefinitely. As long as the stock keeps going higher (or lower) fast enough, we can make money on each adjustment. When the stock doesn't move enough before we need to make an adjustment, we'll lose money to defend the position and push the expiry date further out. 

```{r XYZ-Straddle-Multimodal, fig.align = "center", out.width = out_width_plot, message = FALSE}
Call_cost <- 10; Put_cost <- 15
Call_K <- 200; Put_K <- 200
x_min <- 120; x_max = 280
Stock_cost <- 200

Breakeven_right <- Put_K - Put_cost - Call_cost
Breakeven_left <- Call_K + Call_cost + Put_cost

Call_Payoff_XYZ <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Call_y" = -Call_cost + (Call_x > Call_K)*(Call_x-Call_K),
                            "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) > 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                          "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                          "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) >= 0,
                                                "Profit_put", "Loss_put") )

Straddle_Payoff_XYZ_left <- tibble( "Straddle_x" = seq(from = x_min, to = Breakeven_right, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_XYZ_center <- tibble( "Straddle_x" = seq(from = Breakeven_right, to = Breakeven_left, by = 0.01),
                                      "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                      - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                      "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                             - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_center_straddle","Loss_center_straddle") )  

Straddle_Payoff_XYZ_right <- tibble( "Straddle_x" = seq(from = Breakeven_left, to = x_max, by = 0.01),
                                     "Straddle_y" = -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                     - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K),
                                     "Profitable" = ifelse( -Put_cost - (Straddle_x < Put_K) * (Straddle_x - Put_K) 
                                                            - Call_cost + (Straddle_x > Call_K)*(Straddle_x-Call_K) > 0, 
                                                            "Profit_right_straddle","Loss_right_straddle") )  

Straddle_Payoff_Multimodal <- tibble( "Dist_x" = seq(from = x_min, to = x_max, by = 0.01), 
                                      "Dist_y" = 2.5 * 1000 * dnorMix( x = Dist_x, 
                                                          obj = norMix(mu = c(175, 220), sigma = c(10,17.5), w = c(0.4,0.6)) ) )

temp <- straddle_payoff_dist_overlay( data_straddle_left = Straddle_Payoff_XYZ_left,
                                      data_straddle_center = Straddle_Payoff_XYZ_center,
                                      data_straddle_right = Straddle_Payoff_XYZ_right,
                                      data_distribution_overlay = Straddle_Payoff_Multimodal, 
                                      fill_rgb = col2rgb("cornflowerblue"),
                                      main_title = "Straddle",
                                      sub_title = "A third trader's view of probable future market prices.",
                                      curve_text = "She thinks \nit is likely more \nthan $200 or less \nthan $200.",
                                      curve_text_x = 220.5, 
                                      curve_text_y = 17 )
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) )
temp; rm(temp)
```
The third trader (above) has a more complicated view of possible future prices. Her 

## Collar 

In the covered call, we bought 100 shares and sold 1 call. In the protective put, we bought 100 shares and bought 1 put. In the collar, we *combine* these two strategies: we buy 100 shares, buy 1 put, and sell 1 call. The idea here is that we want the protection offered by the put, but we want to offset the cost of the put so we sell a call too. 

```{r XYZ-Collar-Left, fig.align = "center", out.width = out_width_plot, message = FALSE}
Put_cost <- 16; Put_K <- 180
Call_cost <- 8; Call_K <- 220
Stock_cost <- 200
x_min <- 120; x_max = 260


Stock_Payoff_XYZ <- tibble( "Stock_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Stock_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Call_Payoff_XYZ_220 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -( -Call_cost + (Call_x > Call_K)*(Call_x-Call_K) ),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) < 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ_180 <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                              "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                              "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) > 0,
                                                    "Profit_put", "Loss_put") )

Collar_Payoff_XYZ <- tibble( "Collar_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Collar_y" = -(-Call_cost + (Collar_x > Call_K)*(Collar_x-Call_K) ) 
                            + ( -Put_cost - (Collar_x < Put_K) * (Collar_x - Put_K) ) + Collar_x - Stock_cost,
                            "Profitable" = ifelse( Collar_y > 0, "Profit_collar","Loss_collar") ) 

sl1 <- bracketsGrob(0.25, 0.345, 0.25, 0.51, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.565, 0.725, 0.49, lwd=2, col="green3")

# fill_color_left <- data.frame(xstart = 120, xend = 200, col = "aliceblue")
# fill_color_right <- data.frame(xstart = 200, xend = 280, col = "aliceblue")

fill_color_right <- data.frame(xstart = 120, xend = 180, col = "white")
fill_color_left <- data.frame(xstart = 180, xend = 260, col = "white")

annotate_arrow_1 <- data.frame(x1 = 155, x2 = 145, y1 = 30, y2 = 25)
annotate_arrow_2 <- data.frame(x1 = 130, x2 = 140, y1 = -5, y2 = 2.5)
annotate_arrow_3 <- data.frame(x1 = 167.5, x2 = 160, y1 = -55, y2 = -47.5)

temp <- collar_payoff_left(data_collar = Collar_Payoff_XYZ, data_stock = Stock_Payoff_XYZ,
                      data_call = Call_Payoff_XYZ_220, data_put = Put_Payoff_XYZ_180,
                      main_title = "Collar", 
                      sub_title = "")
                      # sub_title = "Buy 100 shares of at $200/share.\nSell 1 call for $8/share at the $220 strike.\nBuy 1 put for $16/share at the $180 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) +
     # annotate( geom = "text", x = 125, y = -11, color = "red", hjust = 0,
     #           label = paste0("Losses"), size = 5 ) +
     # annotate( geom = "text", x = 255, y = 5, color = "green3", hjust = 0,
     #           label = paste0("Profits"), size = 5 ) +
     annotate( geom = "text", x = Call_K+Call_cost-35, y = min(y_axis_labels), color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost-Call_cost+Put_cost)), size = 4 ) +
     annotate( geom = "text", x = Call_K+Call_cost-35, y = min(y_axis_labels), color = "red", hjust = 0,
               label = "Breakev", size = 4 ) + 
     # annotation_custom( sl1 ) + annotation_custom( sl2 )
     annotate( geom = "text", x = 157.5, y = 30, color = "gray50", hjust = 0, 
               label = paste0("Put"), size = 4 ) +
     annotate( geom = "text", x = 160, y = -60, color = "gray50", hjust = 0, 
               label = paste0("Shares"), size = 4 ) + 
     annotate( geom = "text", x = 120, y = -7, color = "gray50", hjust = 0, 
               label = paste0("Call"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate("point", x = 180-16, y = 0, colour = "gray50") + 
     annotate( geom = "text", x = 180-16-4, y = -7.5, color = "gray50", hjust = 0,
               label = paste0("$164"), size = 3.5 ) +
     annotate("point", x = 200, y = 0, colour = "gray50") +
     annotate( geom = "text", x = 200-9, y = 3, color = "gray50", hjust = 0,
               label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 228, y = 0, colour = "gray65") + 
     annotate( geom = "text", x = 228-5, y = -7.5, color = "gray65", hjust = 0,
               label = paste0("$228"), size = 3.5 ) 
     

temp; rm(temp)
```

```{r XYZ-Collar-Right, fig.align = "center", out.width = out_width_plot, message = FALSE}
Put_cost <- 16; Put_K <- 180
Call_cost <- 8; Call_K <- 220
Stock_cost <- 200
x_min <- 120; x_max = 260


Stock_Payoff_XYZ <- tibble( "Stock_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Stock_y" = -Stock_cost + seq(from = x_min, to = x_max, by = 0.01),
                            "Profitable" = ifelse(-Stock_cost + seq(from = x_min, to = x_max, by = 0.01) > 0, 
                                                  "Profit_stock","Loss_stock") )

Call_Payoff_XYZ_220 <- tibble( "Call_x" = seq(from = x_min, to = x_max, by = 0.01),
                               "Call_y" = -( -Call_cost + (Call_x > Call_K)*(Call_x-Call_K) ),
                               "Profitable" = ifelse(-Call_cost + (Call_x > Call_K)*(Call_x-Call_K) < 0, 
                                                      "Profit_call","Loss_call") )

Put_Payoff_XYZ_180 <- tibble( "Put_x" = seq(from = x_min, to = x_max, by = 0.01),
                              "Put_y" = -Put_cost - (Put_x < Put_K) * (Put_x - Put_K),
                              "Profitable" = ifelse(-Put_cost - (Put_x < Put_K) * (Put_x - Put_K) > 0,
                                                    "Profit_put", "Loss_put") )

Collar_Payoff_XYZ <- tibble( "Collar_x" = seq(from = x_min, to = x_max, by = 0.01),
                            "Collar_y" = -(-Call_cost + (Collar_x > Call_K)*(Collar_x-Call_K) ) 
                            + ( -Put_cost - (Collar_x < Put_K) * (Collar_x - Put_K) ) + Collar_x - Stock_cost,
                            "Profitable" = ifelse( Collar_y > 0, "Profit_collar","Loss_collar") ) 

# fill_color_left <- data.frame(xstart = 120, xend = 200, col = "aliceblue")
# fill_color_right <- data.frame(xstart = 200, xend = 280, col = "aliceblue")

fill_color_right <- data.frame(xstart = 120, xend = 180, col = "white")
fill_color_left <- data.frame(xstart = 180, xend = 260, col = "white")

annotate_arrow_1 <- data.frame(x1 = 215, x2 = 225, y1 = 40, y2 = 35)
annotate_arrow_2 <- data.frame(x1 = 210, x2 = 220, y1 = -27.5, y2 = -20)
annotate_arrow_3 <- data.frame(x1 = 247.5, x2 = 240, y1 = 0, y2 = -7.5)

sl1 <- bracketsGrob(0.25, 0.345, 0.25, 0.51, lwd=2, col="red")
sl2 <- bracketsGrob(0.725, 0.55, 0.725, 0.49, lwd=2, col="green3")

temp <- collar_payoff_right(data_collar = Collar_Payoff_XYZ, data_stock = Stock_Payoff_XYZ,
                      data_call = Call_Payoff_XYZ_220, data_put = Put_Payoff_XYZ_180,
                      main_title = "Collar", 
                      sub_title = "")
                      # sub_title = "Buy 100 shares at $200/share.\nSell 1 call for $8/share at the $220 strike.\nBuy 1 put for $16/share at the $180 strike.")
y_axis_labels <- na.omit( ggplot_build(temp)$layout$panel_params[[1]]$y$get_labels() )
y_axis_labels <- as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels)))
tick_color <- ifelse( as.numeric(gsub('\\(','-',gsub('[)$,]', '', y_axis_labels))) < 0,
                      "red", "green3" )

temp <- temp + theme( axis.text.y = element_markdown(colour = tick_color) ) +
     # annotate( geom = "text", x = 125, y = -11, color = "red", hjust = 0,
     #           label = paste0("Losses"), size = 5 ) +
     # annotate( geom = "text", x = 255, y = 5, color = "green3", hjust = 0,
     #           label = paste0("Profits"), size = 5 ) +
     annotate( geom = "text", x = Call_K+Call_cost-35, y = min(y_axis_labels)-20, color = "green3", hjust = 0,
               label = paste0("Breakeven: ", scales::dollar(Stock_cost-Call_cost+Put_cost)), size = 4 ) +
     annotate( geom = "text", x = Call_K+Call_cost-35, y = min(y_axis_labels)-20, color = "red", hjust = 0,
               label = "Breakev", size = 4 ) + 
     # annotation_custom( sl1 ) + annotation_custom( sl2 )
     annotate( geom = "text", x = 202.5, y = -27.5, color = "gray50", hjust = 0, 
               label = paste0("Put"), size = 4 ) +
     annotate( geom = "text", x = 205, y = 47.5, color = "gray50", hjust = 0, 
               label = paste0("Shares"), size = 4 ) + 
     annotate( geom = "text", x = 249, y = 0, color = "gray50", hjust = 0, 
               label = paste0("Call"), size = 4 ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_1,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_2,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     geom_curve( aes(x = x1, y = y1, xend = x2, yend = y2), data = annotate_arrow_3,
                 arrow = arrow(length = unit(0.03, "npc")), color = "gray50" ) + 
     annotate("point", x = 180-16, y = 0, colour = "gray65") + 
     annotate( geom = "text", x = 180-16-4, y = -7.5, color = "gray65", hjust = 0,
               label = paste0("$164"), size = 3.5 ) +
     annotate("point", x = 200, y = 0, colour = "gray50") +
     annotate( geom = "text", x = 200-9, y = 3, color = "gray50", hjust = 0,
               label = paste0("$200"), size = 3.5 ) +
     annotate("point", x = 228, y = 0, colour = "gray50") + 
     annotate( geom = "text", x = 228-5, y = -7.5, color = "gray50", hjust = 0,
               label = paste0("$228"), size = 3.5 ) 
     

temp; rm(temp)
```